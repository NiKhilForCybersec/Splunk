<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CyberArk Identity | myfirstpro Detection Engineering</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <div class="app-container">
                                                    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <a href="../index.html" style="display:flex;align-items:center;gap:12px;text-decoration:none;color:inherit;">
            <div class="sidebar-logo-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            </div>
            <div class="sidebar-logo-text">
              <h1>Splunk Reference</h1>
              <span>Log & Detection Engineering</span>
            </div>
          </a>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Getting Started</div>
          <a href="../index.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg><span>Command Center</span></a>
          <a href="day1.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/></svg><span>Day 1 Checklist</span></a>
          <a href="professional-excellence.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg><span>Professional Excellence</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Client Delivery</div>
          <a href="client-delivery.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><span>Delivery Playbook</span></a>
          <a href="detection-template.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg><span>Use Case Template</span></a>
          <a href="rba-design.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/></svg><span>RBA Design Guide</span></a>
          <a href="cim-mapping.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg><span>CIM Mapping Guide</span></a>
          <a href="es-mechanics.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg><span>ES Mechanics</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Splunk Platform</div>
          <a href="splunk-fundamentals.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><span>Splunk 101</span></a>
          <a href="splunk-architecture.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg><span>Architecture</span></a>
          <a href="splunk-apps.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg><span>Apps & Add-ons</span></a>
          <a href="splunk-es.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg><span>Enterprise Security</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Log Engineering</div>
          <a href="log-onboarding.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span>Log Onboarding</span></a>
          <a href="data-inputs.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><span>Data Inputs</span></a>
          <a href="data-flow.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span>Data Flow</span></a>
          <a href="parsing-cim.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg><span>Parsing & CIM</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">SPL Mastery</div>
          <a href="splunk-howto.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg><span>SPL How-To</span></a>
          <a href="spl-reference.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg><span>SPL Reference</span></a>
          <a href="lookups.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg><span>Lookups</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Detection Development</div>
          <a href="correlation-searches.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><span>Correlation Searches</span></a>
          <a href="detection-lifecycle.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/></svg><span>Detection Lifecycle</span></a>
          <a href="decision-trees.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="3"/><line x1="12" y1="8" x2="12" y2="14"/><circle cx="6" cy="19" r="3"/><circle cx="18" cy="19" r="3"/></svg><span>Decision Trees</span></a>
          <a href="troubleshooting.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><span>Troubleshooting</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Data Sources</div>
          <a href="vendor-akamai.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg><span>Akamai WAF</span></a>
          <a href="vendor-entra.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><span>Entra ID</span></a>
          <a href="vendor-cyberark.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg><span>CyberArk</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Active Projects</div>
          <a href="waf-overview.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span>WAF/DDoS Project</span></a>
          <a href="waf-usecases.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg><span>WAF Use Cases</span></a>
          <a href="mfa-overview.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg><span>MFA Project</span></a>
          <a href="mfa-usecases.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg><span>MFA Use Cases</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Operations</div>
          <a href="splunk-ops.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg><span>Splunk Cloud Admin</span></a>
          <a href="client-comm.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><span>Client Comms</span></a>
          <a href="runbooks.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg><span>Runbooks</span></a>
          <a href="cheat-sheets.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="3" x2="9" y2="21"/></svg><span>Cheat Sheets</span></a>
        </div>
      </nav>
      <div class="sidebar-footer"><p>Log & Detection Engineering v3.0</p></div>
    </aside>

    <main class="main-content">
      <header class="header">
        <div class="header-left">
          <button class="menu-toggle" aria-label="Toggle menu">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
          </button>
          <div class="breadcrumb">
            <a href="../index.html" class="breadcrumb-item">Home</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item">Vendors</span>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item current">CyberArk</span>
          </div>
        </div>
        <span class="badge cyberark">PRIMARY MFA</span>
      </header>

      <div class="page-content">
        <div class="section">
          <h1 class="section-title">CyberArk Identity Data Reference</h1>
          <p class="section-subtitle">Primary MFA source for privileged users at myfirstpro</p>
        </div>


        <!-- CyberArk Authentication Flow -->
        <div class="section">
          <h2 class="subsection-title">CyberArk Authentication Flow</h2>
          <div class="card" style="padding:24px;background:var(--gray-50);overflow-x:auto;">
            <div class="mermaid">
flowchart LR
    A[User Login] --> B[Entra ID SSO]
    B --> C{Privileged<br/>User?}
    C -->|Yes| D[CyberArk MFA]
    C -->|No| E[Entra MFA]
    D --> F[Identity Audit Log]
    E --> G[Sign-in Log]
    F --> H[Splunk]
    G --> H
    H --> I[MFA Detections]
    
    style D fill:#6f2da8,stroke:#5a2587,color:#fff
    style I fill:#65a637,stroke:#4a7c28,color:#fff
            </div>
          </div>
        </div>


        <!-- Critical Notice -->
        <div class="callout critical">
          <svg class="callout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/></svg>
          <div class="callout-content">
            <div class="callout-title">CyberArk is PRIMARY for Privileged User MFA</div>
            <div class="callout-body">
              Query CyberArk logs <strong>FIRST</strong> for MFA fatigue detection on privileged accounts. Entra ID is secondary for standard users.<br>
              <strong>Index:</strong> <code>cyberark</code> | <strong>Sourcetype:</strong> <code>cyberark:identity:audit</code><br>
              <span style="font-size:0.8rem;color:var(--gray-500);">Note: Sourcetype varies by integration method. Official Splunk Add-on uses <code>iis:events</code>. Verify with: <code>| metadata type=sourcetypes index=cyberark</code></span>
            </div>
          </div>
        </div>

        <!-- ==================== RAW LOG JOURNEY ==================== -->
        <div class="section">
          <h2 class="subsection-title">üìú Raw Log Journey: Source ‚Üí Splunk ‚Üí Detection</h2>
          <p style="color:var(--gray-600);margin-bottom:24px;">See exactly how CyberArk Identity logs transform at each stage</p>

          <!-- STAGE 1: Raw from CyberArk -->
          <div class="card" style="padding:20px;margin-bottom:16px;border-left:4px solid #6f2da8;">
            <h4 style="color:#6f2da8;margin-bottom:12px;">üì§ Stage 1: Raw JSON from CyberArk Identity</h4>
            <p style="font-size:0.8125rem;color:var(--gray-600);margin-bottom:12px;">This is what CyberArk Identity sends via audit log export/SIEM connector:</p>
            <div class="code-block">
              <div class="code-header"><span class="code-title">Raw CyberArk Identity Audit Event (JSON)</span></div>
              <div class="code-body">
                <pre style="font-size:0.75rem;"><code>{
  "TenantId": "TENANT-12345-ABCDE",
  "EventType": "Cloud.Core.MfaDenied",
  "EventCategory": "Authentication",
  "Timestamp": "2025-01-30T10:15:30.123Z",
  "Username": "john.admin@myfirstpro.com",
  "ActorId": "john.admin@myfirstpro.com",
  "ActorType": "User",
  "Result": "Failure",
  "ResultReason": "UserDenied",
  "FromIPAddress": "198.51.100.25",
  "ClientIP": "198.51.100.25",
  "DeviceId": "device-abc123",
  "DeviceOS": "iOS 17.2",
  "Application": "O365 Admin Portal",
  "AuthMethod": "Push",
  "MfaMethod": "MobileAuthenticator",
  "City": "Toronto",
  "Country": "CA",
  "State": "Ontario",
  "UserAgent": "CyberArk Identity/5.2.1 iOS",
  "SessionId": "sess-xyz789",
  "RequestId": "req-def456",
  "AdditionalData": {
    "PolicyName": "PrivilegedMFA",
    "RiskScore": "High",
    "PushCount": "7"
  }
}</code></pre>
              </div>
            </div>
          </div>

          <!-- STAGE 2: In Splunk _raw -->
          <div class="card" style="padding:20px;margin-bottom:16px;border-left:4px solid #65a637;">
            <h4 style="color:#65a637;margin-bottom:12px;">üì• Stage 2: Arrives in Splunk (_raw field)</h4>
            <p style="font-size:0.8125rem;color:var(--gray-600);margin-bottom:12px;">When the event hits Splunk via HEC or forwarder:</p>
            <div class="code-block">
              <div class="code-header"><span class="code-title">Splunk _raw (JSON String)</span></div>
              <div class="code-body">
                <pre style="font-size:0.75rem;"><code>index=cyberark sourcetype=cyberark:identity:audit earliest=-5m | head 1 | table _raw

_raw:
{"TenantId":"TENANT-12345-ABCDE","EventType":"Cloud.Core.MfaDenied","EventCategory":"Authentication","Timestamp":"2025-01-30T10:15:30.123Z","Username":"john.admin@myfirstpro.com","ActorId":"john.admin@myfirstpro.com","Result":"Failure","ResultReason":"UserDenied","FromIPAddress":"198.51.100.25","MfaMethod":"MobileAuthenticator","City":"Toronto","Country":"CA"...}</code></pre>
              </div>
            </div>
            <div class="callout info" style="margin-top:12px;padding:12px;">
              <div class="callout-content">
                <div class="callout-body" style="font-size:0.8125rem;">
                  <strong>Good News:</strong> CyberArk uses flat JSON (no deep nesting), so with <code>KV_MODE=json</code>, fields extract automatically!
                </div>
              </div>
            </div>
          </div>

          <!-- STAGE 3: After Field Extraction -->
          <div class="card" style="padding:20px;margin-bottom:16px;border-left:4px solid var(--primary-500);">
            <h4 style="color:var(--primary-700);margin-bottom:12px;">‚öôÔ∏è Stage 3: After JSON Field Extraction</h4>
            <p style="font-size:0.8125rem;color:var(--gray-600);margin-bottom:12px;">With KV_MODE=json in props.conf, all fields become searchable:</p>
            <div class="code-block">
              <div class="code-header"><span class="code-title">Extracted Fields (Automatic with KV_MODE=json)</span></div>
              <div class="code-body">
                <pre style="font-size:0.75rem;"><code>index=cyberark sourcetype=cyberark:identity:audit earliest=-5m | head 1 | table *

EXTRACTED FIELDS:
_time           = 2025-01-30 10:15:30
EventType       = Cloud.Core.MfaDenied
EventCategory   = Authentication
Username        = john.admin@myfirstpro.com
ActorId         = john.admin@myfirstpro.com
Result          = Failure
ResultReason    = UserDenied
FromIPAddress   = 198.51.100.25
ClientIP        = 198.51.100.25
MfaMethod       = MobileAuthenticator
AuthMethod      = Push
Application     = O365 Admin Portal
DeviceOS        = iOS 17.2
City            = Toronto
Country         = CA
State           = Ontario</code></pre>
              </div>
            </div>
          </div>

          <!-- STAGE 4: CIM Mapped -->
          <div class="card" style="padding:20px;margin-bottom:16px;border-left:4px solid var(--success-500);">
            <h4 style="color:var(--success-700);margin-bottom:12px;">‚úÖ Stage 4: CIM-Mapped Fields (Detection Ready)</h4>
            <p style="font-size:0.8125rem;color:var(--gray-600);margin-bottom:12px;">With field aliases, data maps to Authentication data model:</p>
            <div class="code-block">
              <div class="code-header"><span class="code-title">CIM Fields (Ready for Detections)</span></div>
              <div class="code-body">
                <pre style="font-size:0.75rem;"><code>index=cyberark sourcetype=cyberark:identity:audit earliest=-5m | head 1 
| table _time user src_ip action authentication_method app authentication_result

CIM FIELDS:
_time                    = 2025-01-30 10:15:30
user                     = john.admin@myfirstpro.com  ‚Üê Username/ActorId
src_ip                   = 198.51.100.25              ‚Üê FromIPAddress/ClientIP
action                   = failure                     ‚Üê mapped from Result
authentication_method    = MobileAuthenticator         ‚Üê MfaMethod
app                      = O365 Admin Portal           ‚Üê Application
authentication_result    = failure                     ‚Üê Result (normalized)</code></pre>
              </div>
            </div>
          </div>

          <!-- Visual Summary -->
          <div class="card" style="padding:24px;background:var(--gray-50);margin-bottom:24px;">
            <h4 style="margin-bottom:16px;">üîÑ Field Transformation Summary</h4>
            <div class="table-container">
              <table style="font-size:0.8125rem;">
                <thead><tr><th>Stage</th><th>CyberArk Field</th><th>‚Üí</th><th>Splunk Field</th><th>‚Üí</th><th>CIM Field</th></tr></thead>
                <tbody>
                  <tr><td>User</td><td><code>Username</code> / <code>ActorId</code></td><td>‚Üí</td><td><code>Username</code></td><td>‚Üí</td><td><code>user</code></td></tr>
                  <tr><td>IP</td><td><code>FromIPAddress</code></td><td>‚Üí</td><td><code>FromIPAddress</code></td><td>‚Üí</td><td><code>src_ip</code></td></tr>
                  <tr><td>Event</td><td><code>EventType</code></td><td>‚Üí</td><td><code>EventType</code></td><td>‚Üí</td><td><code>action</code></td></tr>
                  <tr><td>Result</td><td><code>Result</code></td><td>‚Üí</td><td><code>Result</code></td><td>‚Üí</td><td><code>authentication_result</code></td></tr>
                  <tr><td>MFA</td><td><code>MfaMethod</code></td><td>‚Üí</td><td><code>MfaMethod</code></td><td>‚Üí</td><td><code>authentication_method</code></td></tr>
                  <tr><td>App</td><td><code>Application</code></td><td>‚Üí</td><td><code>Application</code></td><td>‚Üí</td><td><code>app</code></td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Sample Detection Using CIM -->
          <div class="card bordered-left success" style="padding:20px;">
            <h4 style="color:var(--success-700);margin-bottom:12px;">üéØ Now You Can Write Detections!</h4>
            <p style="font-size:0.8125rem;color:var(--gray-600);margin-bottom:12px;">With extracted fields, MFA fatigue detection is straightforward:</p>
            <div class="code-block">
              <div class="code-header"><span class="code-title">Detection: MFA Push Bombing on Privileged User</span></div>
              <div class="code-body">
                <pre style="font-size:0.75rem;"><code>index=cyberark sourcetype=cyberark:identity:audit earliest=-15m
    EventType IN ("Cloud.Core.MfaDenied", "Cloud.Core.MfaTimeout")
| lookup privileged_users.csv userPrincipalName AS Username OUTPUT is_privileged role
| where is_privileged="true"
| bin _time span=10m
| stats count as denials 
        dc(FromIPAddress) as unique_ips 
        values(City) as cities 
        latest(role) as role 
        BY _time Username
| where denials >= 5
| eval severity = if(denials >= 10, "CRITICAL", "HIGH")
| eval alert = "MFA Push Bombing: ".Username." (".role.") - ".denials." denials in 10 min"
| table _time Username role denials unique_ips cities severity alert</code></pre>
              </div>
            </div>
          </div>
        </div>

        <!-- Key Event Types -->
        <div class="section">
          <h2 class="subsection-title">MFA-Related Event Types</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr><th>EventType</th><th>Description</th><th>Detection Use</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td class="highlight"><code>Cloud.Core.MfaAuthentication</code></td>
                  <td>MFA challenge response (success/failure)</td>
                  <td>Primary for fatigue detection</td>
                </tr>
                <tr>
                  <td class="highlight"><code>Cloud.Core.MfaDenied</code></td>
                  <td>User explicitly denied MFA push</td>
                  <td>Key indicator for push bombing</td>
                </tr>
                <tr>
                  <td class="highlight"><code>Cloud.Core.MfaTimeout</code></td>
                  <td>MFA challenge timed out</td>
                  <td>May indicate fatigue or absence</td>
                </tr>
                <tr>
                  <td><code>Cloud.Core.MfaChallenge</code></td>
                  <td>MFA challenge initiated</td>
                  <td>Volume tracking</td>
                </tr>
                <tr>
                  <td><code>Cloud.Core.Login</code></td>
                  <td>User login attempt</td>
                  <td>Auth tracking</td>
                </tr>
                <tr>
                  <td><code>Cloud.Core.Logout</code></td>
                  <td>User logout</td>
                  <td>Session tracking</td>
                </tr>
                <tr>
                  <td><code>Cloud.Saas.AppLaunch</code></td>
                  <td>Application access via SSO</td>
                  <td>Activity monitoring</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Field Schema -->
        <div class="section">
          <h2 class="subsection-title">CyberArk Identity Log Schema</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr><th>Field</th><th>Type</th><th>Description</th><th>CIM Mapping</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td class="highlight"><code>ActorId</code></td>
                  <td>string</td>
                  <td>User email/identifier</td>
                  <td><code>user</code></td>
                </tr>
                <tr>
                  <td class="highlight"><code>Result</code></td>
                  <td>string</td>
                  <td>Success, Failure, Denied, Timeout</td>
                  <td><code>action</code></td>
                </tr>
                <tr>
                  <td class="highlight"><code>ResultReason</code></td>
                  <td>string</td>
                  <td>Failure reason details</td>
                  <td><code>reason</code></td>
                </tr>
                <tr>
                  <td class="highlight"><code>ClientIP</code></td>
                  <td>string</td>
                  <td>Source IP address</td>
                  <td><code>src</code></td>
                </tr>
                <tr>
                  <td><code>EventType</code></td>
                  <td>string</td>
                  <td>Event category</td>
                  <td>-</td>
                </tr>
                <tr>
                  <td><code>EventTime</code></td>
                  <td>datetime</td>
                  <td>Event timestamp</td>
                  <td><code>_time</code></td>
                </tr>
                <tr>
                  <td><code>AuthMethod</code></td>
                  <td>string</td>
                  <td>MFA method used</td>
                  <td><code>authentication_method</code></td>
                </tr>
                <tr>
                  <td><code>Country</code></td>
                  <td>string</td>
                  <td>Source country</td>
                  <td><code>src_country</code></td>
                </tr>
                <tr>
                  <td><code>City</code></td>
                  <td>string</td>
                  <td>Source city</td>
                  <td><code>src_city</code></td>
                </tr>
                <tr>
                  <td><code>DeviceId</code></td>
                  <td>string</td>
                  <td>Device identifier</td>
                  <td><code>dest</code></td>
                </tr>
                <tr>
                  <td><code>TargetId</code></td>
                  <td>string</td>
                  <td>Target application</td>
                  <td><code>app</code></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Result Values -->
        <div class="section">
          <h2 class="subsection-title">Result Values</h2>
          <div class="grid grid-4">
            <div class="card bordered-left success">
              <h4><code>Success</code></h4>
              <p style="font-size:0.8125rem;color:var(--gray-600);">MFA approved successfully</p>
            </div>
            <div class="card bordered-left error">
              <h4><code>Failure</code></h4>
              <p style="font-size:0.8125rem;color:var(--gray-600);">Authentication failed</p>
            </div>
            <div class="card bordered-left critical">
              <h4><code>Denied</code></h4>
              <p style="font-size:0.8125rem;color:var(--gray-600);">User explicitly denied push</p>
            </div>
            <div class="card bordered-left warning">
              <h4><code>Timeout</code></h4>
              <p style="font-size:0.8125rem;color:var(--gray-600);">Challenge expired</p>
            </div>
          </div>
        </div>

        <!-- MFA Fatigue Detection SPL -->
        <div class="section">
          <h2 class="subsection-title">MFA-UC1: MFA Fatigue Detection (CyberArk)</h2>
          <div class="code-block">
            <div class="code-header">
              <span class="code-title">MFA Fatigue / Push Bombing Detection</span>
              <span class="code-lang">SPL</span>
            </div>
            <div class="code-body">
              <pre><code>index=cyberark sourcetype=cyberark:identity:audit earliest=-15m
    EventType IN ("Cloud.Core.MfaAuthentication", "Cloud.Core.MfaDenied", "Cloud.Core.MfaTimeout")
| spath
| eval user = ActorId
| eval mfa_denied = if(Result IN ("Failure", "Denied", "Timeout"), 1, 0)
| eval mfa_success = if(Result == "Success", 1, 0)

``` Enrich with privileged user lookup
| lookup privileged_users.csv userPrincipalName as user OUTPUT is_privileged role department

``` Focus on privileged users only
| where is_privileged = "true"

``` Aggregate by user in 10-minute windows
| bin _time span=10m
| stats 
    sum(mfa_denied) as total_denials 
    sum(mfa_success) as total_successes
    values(ClientIP) as source_ips
    values(City) as cities
    values(Country) as countries
    values(AuthMethod) as auth_methods
    latest(role) as role
    BY _time user

``` Alert threshold: 5+ denials in 10 minutes
| where total_denials >= 5

``` CRITICAL if denials followed by success (likely compromise)
| eval severity = case(
    total_denials >= 5 AND total_successes >= 1, "CRITICAL",
    total_denials >= 10, "CRITICAL",
    total_denials >= 5, "HIGH",
    1=1, "MEDIUM"
)

| eval alert_message = case(
    severity="CRITICAL" AND total_successes >= 1, 
        "MFA FATIGUE SUCCESS - Account likely compromised",
    severity="CRITICAL", 
        "Heavy push bombing attack in progress",
    1=1, 
        "MFA fatigue attack detected"
)

| table _time user role total_denials total_successes source_ips cities severity alert_message</code></pre>
            </div>
          </div>
        </div>

        <!-- Validation Queries -->
        <div class="section">
          <h2 class="subsection-title">Validation Queries</h2>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">Check CyberArk Data Presence</span>
            </div>
            <div class="code-body">
              <pre><code>index=cyberark sourcetype=cyberark:identity:audit earliest=-1h
| stats count as total_events 
        dc(ActorId) as unique_users
        dc(EventType) as event_types
        latest(_time) as last_event
| eval last_event = strftime(last_event, "%Y-%m-%d %H:%M:%S")
| eval status = if(total_events > 0, "‚úÖ Data flowing", "‚ùå No data")</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">MFA Event Distribution</span>
            </div>
            <div class="code-body">
              <pre><code>index=cyberark sourcetype=cyberark:identity:audit earliest=-24h
    EventType IN ("Cloud.Core.MfaAuthentication", "Cloud.Core.MfaDenied", "Cloud.Core.MfaTimeout")
| stats count BY EventType Result
| sort EventType Result</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">Top Users by MFA Denials</span>
            </div>
            <div class="code-body">
              <pre><code>index=cyberark sourcetype=cyberark:identity:audit earliest=-7d
    EventType IN ("Cloud.Core.MfaDenied", "Cloud.Core.MfaTimeout")
| stats count as denials BY ActorId
| sort - denials
| head 20</code></pre>
            </div>
          </div>
        </div>

        <!-- props.conf -->
        <div class="section">
          <h2 class="subsection-title">props.conf Configuration</h2>
          <div class="code-block">
            <div class="code-header">
              <span class="code-title">CyberArk Field Aliases and Normalizations</span>
            </div>
            <div class="code-body">
              <pre><code>[cyberark:identity:audit]
# Timestamp
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3N%Z
TIME_PREFIX = \"EventTime\":\"
MAX_TIMESTAMP_LOOKAHEAD = 50
TZ = UTC

# Parsing
KV_MODE = json
TRUNCATE = 0
SHOULD_LINEMERGE = false

# CIM Field Aliases
FIELDALIAS-user = ActorId AS user
FIELDALIAS-src = ClientIP AS src
FIELDALIAS-app = TargetId AS app
FIELDALIAS-src_city = City AS src_city
FIELDALIAS-src_country = Country AS src_country
FIELDALIAS-authentication_method = AuthMethod AS authentication_method

# Calculated Fields
EVAL-action = case(
    Result=="Success", "success",
    Result IN ("Failure", "Denied", "Timeout"), "failure",
    1=1, lower(Result)
)
EVAL-reason = ResultReason
EVAL-vendor = "CyberArk"
EVAL-product = "Identity"</code></pre>
            </div>
          </div>
        </div>

        <!-- Integration with Entra ID -->
        <div class="section">
          <h2 class="subsection-title">CyberArk + Entra ID Correlation</h2>
          <div class="callout info">
            <svg class="callout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
            <div class="callout-content">
              <div class="callout-title">Federation Pattern</div>
              <div class="callout-body">CyberArk is federated with Entra ID at myfirstpro. Privileged users authenticate via Entra ID SSO, but MFA is handled by CyberArk. This means you may see login events in both systems.</div>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">Combined MFA Detection (Both Sources)</span>
            </div>
            <div class="code-body">
              <pre><code>``` Query both CyberArk and Entra ID, normalize, and combine
(index=cyberark sourcetype=cyberark:identity:audit EventType IN ("Cloud.Core.MfaAuthentication", "Cloud.Core.MfaDenied")) 
OR 
(index=azure sourcetype=azure:aad:signin)
earliest=-30m

| spath

``` Normalize fields across both sources
| eval user = lower(coalesce(ActorId, 'properties.userPrincipalName'))
| eval source_system = case(
    sourcetype=="cyberark:identity:audit", "CyberArk",
    sourcetype=="azure:aad:signin", "EntraID",
    1=1, "Unknown"
)
| eval mfa_denied = case(
    sourcetype=="cyberark:identity:audit" AND Result IN ("Failure", "Denied", "Timeout"), 1,
    sourcetype=="azure:aad:signin" AND 'properties.status.errorCode'==500121, 1,
    1=1, 0
)
| eval mfa_success = case(
    sourcetype=="cyberark:identity:audit" AND Result=="Success", 1,
    sourcetype=="azure:aad:signin" AND 'properties.status.errorCode'==0, 1,
    1=1, 0
)

``` Lookup privileged users
| lookup privileged_users.csv userPrincipalName as user OUTPUT is_privileged role
| where is_privileged = "true"

``` Aggregate across all sources
| bin _time span=10m
| stats sum(mfa_denied) as total_denials
        sum(mfa_success) as total_successes
        values(source_system) as systems_involved
        dc(ClientIP) as unique_ips
        BY _time user role

| where total_denials >= 5

| eval severity = if(total_successes >= 1, "CRITICAL", "HIGH")
| table _time user role total_denials total_successes systems_involved severity</code></pre>
            </div>
          </div>
        </div>

      
        <!-- EDGE CASES & DECISIONS -->
        <div class="section" style="margin-top:48px;border-top:2px solid var(--gray-200);padding-top:32px;">
          <h2 class="subsection-title" style="color:var(--warning-600);">‚ö†Ô∏è MFA Edge Cases & Decisions</h2>
          
          <div class="table-container">
            <table>
              <thead><tr><th>Scenario</th><th>Challenge</th><th>How to Handle</th></tr></thead>
              <tbody>
                <tr><td class="highlight">Service accounts with MFA</td><td>Automation can't do MFA</td><td>Document exclusions with business justification</td></tr>
                <tr><td class="highlight">Shared admin accounts</td><td>Can't attribute to individual</td><td>Flag as risk, recommend individual accounts</td></tr>
                <tr><td class="highlight">VPN MFA vs App MFA</td><td>Different systems, different logs</td><td>Understand which MFA where in auth chain</td></tr>
                <tr><td class="highlight">Federated identity</td><td>Multiple IdPs (Okta ‚Üí Entra ‚Üí CyberArk)</td><td>Map federation chain, correlate events</td></tr>
                <tr><td class="highlight">Legacy apps (no MFA)</td><td>Auth without MFA - blind spot</td><td>Document as risk exception</td></tr>
                <tr><td class="highlight">Contractors/vendors</td><td>Different access patterns</td><td>Separate baseline or flag for review</td></tr>
                <tr><td class="highlight">New hire first login</td><td>Triggers "new device" alerts</td><td>7-day grace period for new accounts</td></tr>
                <tr><td class="highlight">Terminated user activity</td><td>Should be impossible</td><td>CRITICAL alert, correlate with HR list</td></tr>
                <tr><td class="highlight">Password reset flow</td><td>Legitimate MFA events</td><td>Understand normal flow, exclude if needed</td></tr>
                <tr><td class="highlight">MFA method change</td><td>Could be attacker persistence</td><td>Alert on method changes for privileged users</td></tr>
              </tbody>
            </table>
          </div>

          <div class="callout warning" style="margin-top:16px;">
            <div class="callout-content">
              <div class="callout-title">Privileged User List - Ask These Questions</div>
              <div class="callout-body">
                1. <strong>Where is the authoritative list?</strong> (AD group? IAM tool? Spreadsheet?)<br>
                2. <strong>How often is it updated?</strong> (Real-time? Daily? Manual?)<br>
                3. <strong>What makes someone "privileged"?</strong> (Role? Group? System access?)<br>
                4. <strong>Are there tiers?</strong> (Domain Admin vs Server Admin vs Help Desk)<br>
                5. <strong>Are contractors included?</strong><br>
                6. <strong>Who approves changes to the list?</strong>
              </div>
            </div>
          </div>

          <h3 style="font-size:1rem;margin:24px 0 12px;">Field Changes After Upgrades</h3>
          <div class="callout critical">
            <div class="callout-content">
              <div class="callout-title">Watch Out!</div>
              <div class="callout-body">
                CyberArk upgrades may change field names. Handle both old and new:<br>
                <code>| eval user = coalesce(ActorId, UserName, userId, "unknown")</code><br>
                <code>| eval src_ip = coalesce(ClientIP, clientIp, SourceIP)</code>
              </div>
            </div>
          </div>
        </div>

      
        <!-- SITE FOOTER -->
        <footer style="margin-top:48px;padding:24px;background:var(--gray-100);border-radius:8px;text-align:center;font-size:0.85rem;color:var(--gray-600);">
          <div style="margin-bottom:8px;">
            <strong>Splunk Detection Engineering Reference</strong> | Version 2.0 | Last Updated: February 2, 2026
          </div>
          <div>
            Internal Use Only | Detection Engineering Team
          </div>
        </footer>

      </div>
    </main>
  </div>
  <script src="../js/app.js"></script>
  <script>mermaid.initialize({startOnLoad:true, theme:'neutral'});</script>
</body>
</html>
