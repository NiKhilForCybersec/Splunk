<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MFA-UC1: MFA Fatigue Attack | Sobeys Detection Engineering</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          </div>
          <div class="sidebar-logo-text">
            <h1>Sobeys Detection</h1>
            <span>Engineering Command Center</span>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">MFA Project</div>
          <a href="mfa-overview.html" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <span>Project Overview</span>
          </a>
          <a href="mfa-uc1.html" class="nav-item active">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/></svg>
            <span>UC1: MFA Fatigue</span>
          </a>
        </div>
      </nav>
    </aside>

    <main class="main-content">
      <header class="header">
        <div class="header-left">
          <button class="menu-toggle" aria-label="Toggle menu">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
          </button>
          <div class="breadcrumb">
            <a href="../index.html" class="breadcrumb-item">Home</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item">MFA</span>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item current">UC1: MFA Fatigue</span>
          </div>
        </div>
        <div class="header-right">
          <span class="badge critical">Critical Severity</span>
          <span class="badge cyberark">CyberArk Primary</span>
        </div>
      </header>

      <div class="page-content">
        <!-- Header -->
        <div class="section">
          <div class="section-header">
            <h1 class="section-title">MFA-UC1: MFA Fatigue / Push Bombing</h1>
            <p class="section-subtitle">Detect repeated MFA prompts to privileged users indicating credential compromise and social engineering</p>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value">T1621</div>
              <div class="stat-label">MITRE ATT&CK</div>
            </div>
            <div class="stat-card">
              <div class="stat-value critical">Critical</div>
              <div class="stat-label">Severity</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">10 min</div>
              <div class="stat-label">Detection Window</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">CyberArk</div>
              <div class="stat-label">Primary Source</div>
            </div>
          </div>
        </div>

        <!-- Critical Alert -->
        <div class="callout critical">
          <svg class="callout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          <div class="callout-content">
            <div class="callout-title">High-Impact Detection</div>
            <div class="callout-body">If â‰¥5 MFA denials are followed by a success, the account is <strong>likely compromised</strong>. This combination indicates the attacker successfully socially engineered the user or exhausted their patience. Immediate response required.</div>
          </div>
        </div>

        <!-- Threat Description -->
        <div class="section">
          <div class="subsection">
            <h3 class="subsection-title">Attack Pattern</h3>

            <div class="card">
              <p style="margin-bottom: 16px;"><strong>MFA Fatigue</strong> (also known as "Push Bombing" or "MFA Prompt Bombing") is a social engineering technique where an attacker with valid credentials repeatedly triggers MFA prompts until the user approves out of:</p>
              <ul style="margin-left: 20px; color: var(--gray-600); margin-bottom: 16px;">
                <li><strong>Frustration</strong> â€” "Make it stop"</li>
                <li><strong>Confusion</strong> â€” "Maybe I did try to log in"</li>
                <li><strong>Timing</strong> â€” Early morning/late night when less alert</li>
                <li><strong>Accidental approval</strong> â€” Muscle memory on mobile device</li>
              </ul>
              <p><strong>Real-World Examples:</strong> This technique was used in the Uber breach (2022), Okta breach (2022), and numerous other high-profile compromises.</p>
            </div>

            <div class="timeline" style="margin-top: 20px;">
              <div class="timeline-item complete">
                <div class="timeline-content">
                  <h4 class="timeline-title">1. Credential Acquisition</h4>
                  <p class="timeline-body">Attacker obtains valid username/password (phishing, breach, dark web)</p>
                </div>
              </div>
              <div class="timeline-item complete">
                <div class="timeline-content">
                  <h4 class="timeline-title">2. MFA Trigger</h4>
                  <p class="timeline-body">Attacker attempts login, triggering MFA push notification</p>
                </div>
              </div>
              <div class="timeline-item complete">
                <div class="timeline-content">
                  <h4 class="timeline-title">3. User Denies</h4>
                  <p class="timeline-body">User receives unexpected prompt and denies it</p>
                </div>
              </div>
              <div class="timeline-item complete">
                <div class="timeline-content">
                  <h4 class="timeline-title">4. Repeated Bombing</h4>
                  <p class="timeline-body">Attacker triggers 5, 10, 20+ prompts rapidly</p>
                </div>
              </div>
              <div class="timeline-item">
                <div class="timeline-content">
                  <h4 class="timeline-title">5. User Capitulates</h4>
                  <p class="timeline-body">Exhausted user finally approves â†’ Account compromised</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Why CyberArk Primary -->
        <div class="section">
          <div class="subsection">
            <h3 class="subsection-title">Why CyberArk is Primary</h3>

            <div class="callout info">
              <svg class="callout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
              <div class="callout-content">
                <div class="callout-title">CyberArk handles privileged MFA at Sobeys</div>
                <div class="callout-body">Query CyberArk logs <strong>first</strong> for privileged user MFA events. Entra ID is secondary for standard users. This ensures highest-risk accounts are prioritized.</div>
              </div>
            </div>

            <div class="table-container" style="margin-top: 16px;">
              <table>
                <thead>
                  <tr>
                    <th>Source</th>
                    <th>Coverage</th>
                    <th>User Type</th>
                    <th>Priority</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="highlight">CyberArk Identity</td>
                    <td>Privileged access MFA</td>
                    <td>Admins, IT, Security</td>
                    <td><span class="badge critical">Primary</span></td>
                  </tr>
                  <tr>
                    <td class="highlight">Microsoft Entra ID</td>
                    <td>Corporate SSO MFA</td>
                    <td>All corporate users</td>
                    <td><span class="badge info">Secondary</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- SPL Implementation -->
        <div class="section">
          <div class="subsection">
            <h3 class="subsection-title">SPL Implementation</h3>

            <div class="tabs" id="mfa-spl-tabs">
              <div class="tab-list">
                <button class="tab-button active">CyberArk (Primary)</button>
                <button class="tab-button">Entra ID (Secondary)</button>
                <button class="tab-button">Combined (Advanced)</button>
              </div>

              <div class="tab-panel active">
                <div class="code-block">
                  <div class="code-header">
                    <span class="code-title">MFA-UC1: CyberArk MFA Fatigue Detection</span>
                    <span class="code-lang">SPL</span>
                  </div>
                  <div class="code-body">
                    <pre><code>index=cyberark sourcetype=cyberark:identity:audit earliest=-30m
    EventType IN ("Cloud.Core.MfaAuthentication", "Cloud.Core.MfaDenied", "Cloud.Core.MfaTimeout")
| spath
| eval user = ActorId
| eval mfa_denied = if(Result IN ("Failure", "Denied", "Timeout"), 1, 0)
| eval mfa_success = if(Result == "Success", 1, 0)
| eval timestamp = _time

``` Enrich with privileged user lookup
| lookup privileged_users.csv userPrincipalName as user OUTPUT is_privileged role department

``` Focus on privileged users only
| where is_privileged = "true"

``` Aggregate by user and time window
| bin _time span=10m
| stats sum(mfa_denied) as total_denials 
        sum(mfa_success) as total_successes
        values(ClientIP) as source_ips
        values(City) as cities
        values(Country) as countries
        values(AuthMethod) as auth_methods
        earliest(timestamp) as first_event
        latest(timestamp) as last_event
        BY _time user role department

``` Alert conditions
| where total_denials >= 5

``` Determine severity based on pattern
| eval alert_level = case(
    total_denials >= 5 AND total_successes >= 1, "CRITICAL - Likely Compromised",
    total_denials >= 10, "CRITICAL - Heavy Push Bombing",
    total_denials >= 5, "HIGH - MFA Fatigue Attempt",
    true(), "MEDIUM"
)

``` Calculate attack duration
| eval attack_duration_min = round((last_event - first_event) / 60, 1)

``` Format output
| eval alert_title = "MFA Fatigue Attack Detected - ".user
| eval alert_description = "Privileged user ".user." (".role.") received ".total_denials." MFA denials".if(total_successes>0, " followed by ".total_successes." success(es) - ACCOUNT LIKELY COMPROMISED", "")

| table _time user role department alert_level total_denials total_successes 
        source_ips cities countries attack_duration_min 
        alert_title alert_description</code></pre>
                  </div>
                </div>
              </div>

              <div class="tab-panel">
                <div class="code-block">
                  <div class="code-header">
                    <span class="code-title">MFA-UC1: Entra ID MFA Fatigue Detection</span>
                    <span class="code-lang">SPL</span>
                  </div>
                  <div class="code-body">
                    <pre><code>index=azure sourcetype=azure:aad:signin earliest=-30m
| spath

``` Extract key fields
| eval user = 'properties.userPrincipalName'
| eval error_code = 'properties.status.errorCode'
| eval ip_address = 'properties.ipAddress'
| eval city = 'properties.location.city'
| eval country = 'properties.location.countryOrRegion'
| eval mfa_method = 'properties.mfaDetail.authMethod'
| eval app = 'properties.appDisplayName'

``` Identify MFA-related events
``` Error 500121 = User denied MFA / MFA not completed
``` Error 0 = Success
| eval mfa_denied = if(error_code == 500121, 1, 0)
| eval mfa_success = if(error_code == 0, 1, 0)

``` Enrich with privileged user lookup
| lookup privileged_users.csv userPrincipalName as user OUTPUT is_privileged role

``` Focus on privileged users
| where is_privileged = "true"

``` Aggregate
| bin _time span=10m
| stats sum(mfa_denied) as total_denials
        sum(mfa_success) as total_successes
        values(ip_address) as source_ips
        values(city) as cities
        values(country) as countries
        values(app) as applications
        BY _time user role

``` Alert on threshold
| where total_denials >= 5

``` Severity classification
| eval alert_level = case(
    total_denials >= 5 AND total_successes >= 1, "CRITICAL - Likely Compromised",
    total_denials >= 10, "CRITICAL - Heavy Push Bombing", 
    total_denials >= 5, "HIGH - MFA Fatigue Attempt",
    true(), "MEDIUM"
)

| table _time user role alert_level total_denials total_successes source_ips cities applications</code></pre>
                  </div>
                </div>
              </div>

              <div class="tab-panel">
                <div class="code-block">
                  <div class="code-header">
                    <span class="code-title">MFA-UC1: Combined CyberArk + Entra Detection</span>
                    <span class="code-lang">SPL</span>
                  </div>
                  <div class="code-body">
                    <pre><code>``` Query both sources and combine
(index=cyberark sourcetype=cyberark:identity:audit EventType IN ("Cloud.Core.MfaAuthentication", "Cloud.Core.MfaDenied")) 
OR 
(index=azure sourcetype=azure:aad:signin)
earliest=-30m

| spath

``` Normalize fields across sources
| eval user = coalesce(ActorId, 'properties.userPrincipalName')
| eval source_system = case(
    sourcetype=="cyberark:identity:audit", "CyberArk",
    sourcetype=="azure:aad:signin", "Entra ID",
    true(), "Unknown"
)
| eval mfa_denied = case(
    sourcetype=="cyberark:identity:audit" AND Result IN ("Failure", "Denied", "Timeout"), 1,
    sourcetype=="azure:aad:signin" AND 'properties.status.errorCode'==500121, 1,
    true(), 0
)
| eval mfa_success = case(
    sourcetype=="cyberark:identity:audit" AND Result=="Success", 1,
    sourcetype=="azure:aad:signin" AND 'properties.status.errorCode'==0, 1,
    true(), 0
)

``` Lookup privileged users
| lookup privileged_users.csv userPrincipalName as user OUTPUT is_privileged role
| where is_privileged = "true"

``` Aggregate across all sources
| bin _time span=10m
| stats sum(mfa_denied) as total_denials
        sum(mfa_success) as total_successes
        values(source_system) as systems_involved
        BY _time user role

| where total_denials >= 5

| eval alert_level = if(total_successes >= 1, "CRITICAL - COMPROMISED", "HIGH - Push Bombing")
| table _time user role alert_level total_denials total_successes systems_involved</code></pre>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Threshold Configuration -->
        <div class="section">
          <div class="subsection">
            <h3 class="subsection-title">Threshold Configuration</h3>

            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Parameter</th>
                    <th>Value</th>
                    <th>Rationale</th>
                    <th>Tuning Notes</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="highlight">Time Window</td>
                    <td><code>10 minutes</code></td>
                    <td>Typical attack duration</td>
                    <td>Extend to 15m if attacks are slower</td>
                  </tr>
                  <tr>
                    <td class="highlight">Denial Threshold</td>
                    <td><code>â‰¥5 denials</code></td>
                    <td>Exceeds normal user behavior</td>
                    <td>Lower to 3 for critical admins</td>
                  </tr>
                  <tr>
                    <td class="highlight">User Scope</td>
                    <td><code>Privileged only</code></td>
                    <td>High-value targets</td>
                    <td>Can expand to all users with higher threshold</td>
                  </tr>
                  <tr>
                    <td class="highlight">Critical Trigger</td>
                    <td><code>Denials + Success</code></td>
                    <td>Indicates compromise</td>
                    <td>Always immediate escalation</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- False Positive Analysis -->
        <div class="section">
          <div class="subsection">
            <h3 class="subsection-title">False Positive Analysis</h3>

            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>FP Source</th>
                    <th>Characteristics</th>
                    <th>Verification</th>
                    <th>Mitigation</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Phone/connectivity issues</td>
                    <td>Single location, user-reported</td>
                    <td>Check device health logs</td>
                    <td>Verify with user, document</td>
                  </tr>
                  <tr>
                    <td>User traveling</td>
                    <td>Location change, timing correlates</td>
                    <td>Correlate with travel records</td>
                    <td>Temporary exception</td>
                  </tr>
                  <tr>
                    <td>App stuck in loop</td>
                    <td>Single app, regular interval</td>
                    <td>Check application logs</td>
                    <td>Fix application, exclude temporarily</td>
                  </tr>
                  <tr>
                    <td>MFA method change</td>
                    <td>During enrollment/migration</td>
                    <td>Correlate with IAM tickets</td>
                    <td>Time-based suppression</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="callout warning" style="margin-top: 16px;">
              <svg class="callout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/></svg>
              <div class="callout-content">
                <div class="callout-title">Never Auto-Close Without Verification</div>
                <div class="callout-body">Given the critical nature of this detection, never automatically suppress or close alerts. Always verify with the user before closing as FP. An attacker could claim "phone issues" if user is contacted via compromised account.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Response Playbook -->
        <div class="section">
          <div class="subsection">
            <h3 class="subsection-title">Response Playbook</h3>

            <div class="grid grid-2">
              <div class="card bordered-left error">
                <h4 style="margin-bottom: 12px; color: var(--error-600);">ðŸ”´ CRITICAL: Denials + Success</h4>
                <p style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 12px;"><strong>Assume account is compromised.</strong></p>
                <ol style="font-size: 0.8125rem; color: var(--gray-600); margin-left: 16px;">
                  <li>Immediately disable the user account</li>
                  <li>Force password reset</li>
                  <li>Revoke all active sessions</li>
                  <li>Re-enroll MFA device</li>
                  <li>Notify user via out-of-band channel (phone call)</li>
                  <li>Check for post-compromise activity</li>
                  <li>Create IR ticket</li>
                  <li>Preserve logs for investigation</li>
                </ol>
              </div>

              <div class="card bordered-left warning">
                <h4 style="margin-bottom: 12px; color: var(--warning-600);">ðŸŸ¡ HIGH: Denials Only (No Success)</h4>
                <p style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 12px;"><strong>Attack in progress, user held strong.</strong></p>
                <ol style="font-size: 0.8125rem; color: var(--gray-600); margin-left: 16px;">
                  <li>Contact user immediately (phone, not email/chat)</li>
                  <li>Confirm they received unexpected prompts</li>
                  <li>Force password reset (credentials are leaked)</li>
                  <li>Monitor for continued attempts</li>
                  <li>Consider temporary account lock</li>
                  <li>Document incident</li>
                  <li>Security awareness reminder to user</li>
                </ol>
              </div>
            </div>

            <div class="code-block" style="margin-top: 16px;">
              <div class="code-header">
                <span class="code-title">Post-Compromise Activity Check</span>
                <span class="code-lang">SPL</span>
              </div>
              <div class="code-body">
                <pre><code>``` Run this IMMEDIATELY after compromise detection
``` Replace USER_UPN with the affected user

index=azure sourcetype IN (azure:aad:signin, azure:aad:audit) 
    "properties.userPrincipalName"="USER_UPN"
    earliest=-24h
| spath
| eval event_type = case(
    sourcetype=="azure:aad:signin", "Sign-in",
    sourcetype=="azure:aad:audit", "Audit",
    true(), "Other"
)
| eval activity = coalesce('properties.activityDisplayName', 'properties.appDisplayName')
| eval status = coalesce('properties.result', 'properties.status.errorCode')
| eval ip = 'properties.ipAddress'
| eval location = 'properties.location.city'.", ".'properties.location.countryOrRegion'
| table _time event_type activity status ip location
| sort _time</code></pre>
              </div>
            </div>
          </div>
        </div>

        <!-- Test Cases -->
        <div class="section">
          <div class="subsection">
            <h3 class="subsection-title">Test Cases</h3>

            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Test ID</th>
                    <th>Scenario</th>
                    <th>Input</th>
                    <th>Expected</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>TC-MFA1-001</td>
                    <td>Normal MFA usage</td>
                    <td>1-2 denials (typo/accident)</td>
                    <td>No alert</td>
                  </tr>
                  <tr>
                    <td>TC-MFA1-002</td>
                    <td>Threshold breach - denials only</td>
                    <td>6 denials in 10min (privileged)</td>
                    <td>Alert (HIGH)</td>
                  </tr>
                  <tr>
                    <td>TC-MFA1-003</td>
                    <td>Compromise pattern</td>
                    <td>5 denials + 1 success</td>
                    <td>Alert (CRITICAL)</td>
                  </tr>
                  <tr>
                    <td>TC-MFA1-004</td>
                    <td>Standard user excluded</td>
                    <td>6 denials (non-privileged)</td>
                    <td>No alert (not in scope)</td>
                  </tr>
                  <tr>
                    <td>TC-MFA1-005</td>
                    <td>Heavy bombing</td>
                    <td>15 denials in 10min</td>
                    <td>Alert (CRITICAL)</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <script src="../js/app.js"></script>
</body>
</html>
