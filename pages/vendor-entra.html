<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Microsoft Entra ID | Sobeys Detection Engineering</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({startOnLoad:true, theme:'neutral'});</script>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          </div>
          <div class="sidebar-logo-text">
            <h1>Sobeys Detection</h1>
            <span>Engineering Command Center</span>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Vendors</div>
          <a href="vendor-akamai.html" class="nav-item">Akamai WAF</a>
          <a href="vendor-cyberark.html" class="nav-item">CyberArk <span class="badge critical" style="margin-left:auto;font-size:0.6rem">PRIMARY</span></a>
          <a href="vendor-entra.html" class="nav-item active">Entra ID</a>
          <a href="vendor-sapcdc.html" class="nav-item">SAP CDC</a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">MFA Project</div>
          <a href="mfa-overview.html" class="nav-item">Overview</a>
          <a href="mfa-uc1.html" class="nav-item">UC1: MFA Fatigue</a>
          <a href="mfa-uc2-5.html" class="nav-item">UC2-5</a>
        </div>
      </nav>
    </aside>

    <main class="main-content">
      <header class="header">
        <div class="header-left">
          <div class="breadcrumb">
            <a href="../index.html" class="breadcrumb-item">Home</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item">Vendors</span>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item current">Entra ID</span>
          </div>
        </div>
        <span class="badge microsoft">Corporate SSO</span>
      </header>

      <div class="page-content">
        <div class="section">
          <h1 class="section-title">Microsoft Entra ID</h1>
          <p class="section-subtitle">Corporate SSO for all employees, secondary MFA for standard users</p>
        </div>

        <div class="callout info">
          <div class="callout-content">
            <div class="callout-title">Role at Sobeys</div>
            <div class="callout-body">Primary SSO for 129,000 employees. For privileged users, Entra ID federates to CyberArk for MFA. Use Entra ID logs for: location data (UC3/UC4), standard employee MFA, and correlation with CyberArk.</div>
          </div>
        </div>

        <!-- Log Types -->
        <div class="section">
          <h2 class="subsection-title">Entra ID Log Types</h2>
          <div class="table-container">
            <table>
              <thead><tr><th>Log Type</th><th>Sourcetype</th><th>Detection Use</th></tr></thead>
              <tbody>
                <tr><td><strong>Sign-in Logs</strong></td><td><code>azure:aad:signin</code></td><td>PRIMARY - Auth, MFA, location</td></tr>
                <tr><td>Audit Logs</td><td><code>azure:aad:audit</code></td><td>User/role changes, app registration</td></tr>
                <tr><td>Identity Protection</td><td><code>azure:aad:identity</code></td><td>Risk detections</td></tr>
                <tr><td>Provisioning</td><td><code>azure:aad:provisioning</code></td><td>Lifecycle events</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Critical Error Codes -->
        <div class="section">
          <h2 class="subsection-title">Critical Error Codes</h2>
          <div class="table-container">
            <table>
              <thead><tr><th>Code</th><th>Meaning</th><th>Detection Use</th></tr></thead>
              <tbody>
                <tr><td class="highlight"><code>0</code></td><td>Success</td><td>Successful authentication</td></tr>
                <tr><td class="highlight"><code>500121</code></td><td>MFA Denied by User</td><td><strong>PRIMARY for MFA fatigue</strong></td></tr>
                <tr><td class="highlight"><code>50074</code></td><td>Strong auth required, incomplete</td><td>MFA challenge pending</td></tr>
                <tr><td class="highlight"><code>50076</code></td><td>MFA required but failed</td><td>MFA failure tracking</td></tr>
                <tr><td class="highlight"><code>50126</code></td><td>Invalid credentials</td><td>Password failures (credential stuffing)</td></tr>
                <tr><td class="highlight"><code>53003</code></td><td>Blocked by Conditional Access</td><td>Policy enforcement</td></tr>
                <tr><td class="highlight"><code>50053</code></td><td>Account locked</td><td>Lockout detection</td></tr>
                <tr><td class="highlight"><code>50057</code></td><td>Account disabled</td><td>Disabled account access attempt</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Field Reference -->
        <div class="section">
          <h2 class="subsection-title">Field Reference (azure:aad:signin)</h2>
          <div class="table-container">
            <table>
              <thead><tr><th>JSON Path</th><th>Description</th><th>SPL Extract</th></tr></thead>
              <tbody>
                <tr><td><code>properties.userPrincipalName</code></td><td>User email/UPN</td><td><code>spath path=properties.userPrincipalName output=user</code></td></tr>
                <tr><td><code>properties.userId</code></td><td>User GUID</td><td><code>spath path=properties.userId</code></td></tr>
                <tr><td><code>properties.ipAddress</code></td><td>Source IP</td><td><code>spath path=properties.ipAddress output=src</code></td></tr>
                <tr><td><code>properties.status.errorCode</code></td><td>Result code (0=success)</td><td><code>spath path=properties.status.errorCode</code></td></tr>
                <tr><td><code>properties.location.city</code></td><td>Geolocation city</td><td><code>spath path=properties.location.city</code></td></tr>
                <tr><td><code>properties.location.countryOrRegion</code></td><td>Country code</td><td><code>spath path=properties.location.countryOrRegion</code></td></tr>
                <tr><td><code>properties.location.geoCoordinates.latitude</code></td><td>Latitude</td><td>For impossible travel calculation</td></tr>
                <tr><td><code>properties.location.geoCoordinates.longitude</code></td><td>Longitude</td><td>For impossible travel calculation</td></tr>
                <tr><td><code>properties.deviceDetail.deviceId</code></td><td>Device GUID</td><td>New device detection</td></tr>
                <tr><td><code>properties.mfaDetail.authMethod</code></td><td>MFA method used</td><td>Method downgrade detection</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- MFA Fatigue SPL -->
        <div class="section">
          <h2 class="subsection-title">MFA Fatigue Detection (Entra ID - Secondary)</h2>
          <div class="code-block">
            <div class="code-header"><span class="code-title">MFA-UC1: Entra ID Version (for standard users)</span></div>
            <div class="code-body"><pre><code>index=azure sourcetype=azure:aad:signin earliest=-15m
| spath
| eval user = 'properties.userPrincipalName'
| eval error_code = 'properties.status.errorCode'
| eval src = 'properties.ipAddress'
| eval city = 'properties.location.city'
| eval country = 'properties.location.countryOrRegion'

``` Categorize MFA events
| eval mfa_denied = if(error_code=500121, 1, 0)
| eval mfa_incomplete = if(error_code IN (50074, 50076), 1, 0)
| eval success = if(error_code=0, 1, 0)

``` Aggregate per user
| bin _time span=10m
| stats 
    sum(mfa_denied) as denials
    sum(mfa_incomplete) as incomplete
    sum(success) as successes
    values(src) as source_ips
    values(city) as cities
    values(country) as countries
    BY user _time

``` Standard user threshold (higher than privileged)
| where denials >= 10 OR (denials >= 5 AND successes >= 1)

| eval severity = if(denials >= 5 AND successes >= 1, "CRITICAL", "HIGH")
| table _time user denials successes source_ips cities severity</code></pre></div>
          </div>
        </div>

        <!-- Impossible Travel -->
        <div class="section">
          <h2 class="subsection-title">Impossible Travel Detection (MFA-UC4)</h2>
          <div class="code-block">
            <div class="code-header"><span class="code-title">Impossible Travel with Haversine Formula</span></div>
            <div class="code-body"><pre><code>index=azure sourcetype=azure:aad:signin earliest=-24h
| spath
| eval user = 'properties.userPrincipalName'
| eval error_code = 'properties.status.errorCode'
| eval lat = 'properties.location.geoCoordinates.latitude'
| eval lon = 'properties.location.geoCoordinates.longitude'
| eval city = 'properties.location.city'
| eval country = 'properties.location.countryOrRegion'

``` Only successful logins with geo data
| where error_code==0 AND isnotnull(lat) AND isnotnull(lon)

``` Get previous login
| sort user _time
| streamstats current=f last(lat) as prev_lat last(lon) as prev_lon last(_time) as prev_time last(city) as prev_city BY user
| where isnotnull(prev_lat)

``` Haversine distance calculation
| eval lat1_rad = lat * 3.14159265359 / 180
| eval lat2_rad = prev_lat * 3.14159265359 / 180
| eval dlon = (lon - prev_lon) * 3.14159265359 / 180
| eval dlat = (lat - prev_lat) * 3.14159265359 / 180
| eval a = pow(sin(dlat/2), 2) + cos(lat1_rad) * cos(lat2_rad) * pow(sin(dlon/2), 2)
| eval distance_km = 6371 * 2 * asin(sqrt(a))

``` Calculate speed
| eval time_hours = (_time - prev_time) / 3600
| eval speed_kmh = if(time_hours > 0, distance_km / time_hours, 0)

``` Flag impossible travel (>800 km/h, >500km distance)
| where speed_kmh > 800 AND distance_km > 500

| eval distance_km = round(distance_km, 0)
| eval speed_kmh = round(speed_kmh, 0)
| table user prev_city city country distance_km speed_kmh</code></pre></div>
          </div>
        </div>

        <!-- Validation Queries -->
        <div class="section">
          <h2 class="subsection-title">Data Validation</h2>
          <div class="code-block">
            <div class="code-body"><pre><code>``` Check data flow
index=azure sourcetype=azure:aad:signin earliest=-24h | stats count

``` Error code distribution
index=azure sourcetype=azure:aad:signin earliest=-24h
| spath path=properties.status.errorCode output=error_code
| stats count BY error_code | sort -count | head 20

``` MFA events count
index=azure sourcetype=azure:aad:signin earliest=-24h
| spath path=properties.status.errorCode output=error_code
| where error_code IN (0, 500121, 50074, 50076)
| stats count BY error_code

``` Geo data availability
index=azure sourcetype=azure:aad:signin earliest=-1h
| spath path=properties.location.geoCoordinates.latitude output=lat
| eval has_geo = if(isnotnull(lat), "yes", "no")
| stats count BY has_geo</code></pre></div>
          </div>
        </div>

      </div>
    </main>
  </div>
  <script src="../js/app.js"></script>
</body>
</html>
