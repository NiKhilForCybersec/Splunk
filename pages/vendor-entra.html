<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Microsoft Entra ID | myfirstpro Detection Engineering</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <div class="app-container">
                                    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <a href="../index.html" style="display:flex;align-items:center;gap:12px;text-decoration:none;color:inherit;">
            <div class="sidebar-logo-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            </div>
            <div class="sidebar-logo-text">
              <h1>myfirstpro</h1>
              <span>Detection Engineering</span>
            </div>
          </a>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Getting Started</div>
          <a href="../index.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg><span>Command Center</span></a>
          <a href="day1.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/></svg><span>Day 1 Checklist</span></a>
          <a href="client-comm.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg><span>Client Communication</span></a>
          <a href="professional-excellence.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg><span>Professional Excellence</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Splunk Fundamentals</div>
          <a href="splunk-fundamentals.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><span>Splunk 101</span></a>
          <a href="splunk-es.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg><span>Enterprise Security</span></a>
          <a href="data-flow.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span>Data Flow & Event Hub</span></a>
          <a href="detection-lifecycle.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/></svg><span>Detection Lifecycle</span></a>
          <a href="splunk-howto.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg><span>Splunk How-To Guide</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Data Sources</div>
          <a href="vendor-akamai.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg><span>Akamai WAF</span></a>
          <a href="vendor-cyberark.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg><span>CyberArk Identity</span></a>
          <a href="vendor-entra.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><span>Entra ID</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Splunk Operations</div>
          <a href="waf-onboarding.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span>Log Onboarding</span></a>
          <a href="parsing-cim.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg><span>Parsing & CIM</span></a>
          <a href="lookups.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg><span>Lookups Deep Dive</span></a>
          <a href="splunk-ops.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg><span>Splunk Cloud Ops</span></a>
          <a href="spl-reference.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg><span>SPL Reference</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">WAF/DDoS Project</div>
          <a href="waf-overview.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span>Project Overview</span></a>
          <a href="waf-usecases.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg><span>Use Cases (UC1-8)</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">MFA Project</div>
          <a href="mfa-overview.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span>Project Overview</span></a>
          <a href="mfa-usecases.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg><span>Use Cases (UC1-5)</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Response & Support</div>
          <a href="decision-trees.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="3"/><line x1="12" y1="8" x2="12" y2="14"/><circle cx="6" cy="19" r="3"/><circle cx="18" cy="19" r="3"/></svg><span>Decision Trees</span></a>
          <a href="troubleshooting.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><span>Troubleshooting</span></a>
          <a href="runbooks.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg><span>SOC Runbooks</span></a>
        </div>
      </nav>
      <div class="sidebar-footer"><p>Detection Engineering v2.0</p></div>
    </aside>

    <main class="main-content">
      <header class="header">
        <div class="header-left">
          <button class="menu-toggle" aria-label="Toggle menu">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
          </button>
          <div class="breadcrumb">
            <a href="../index.html" class="breadcrumb-item">Home</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item">Vendors</span>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item current">Entra ID</span>
          </div>
        </div>
        <span class="badge microsoft">Corporate SSO</span>
      </header>

      <div class="page-content">
        <div class="section">
          <h1 class="section-title">Microsoft Entra ID</h1>
          <p class="section-subtitle">Corporate SSO for all employees, secondary MFA source for standard users</p>
        </div>


        <!-- Entra ID Sign-in Flow -->
        <div class="section">
          <h2 class="subsection-title">Entra ID Sign-in Flow</h2>
          <div class="card" style="padding:24px;background:var(--gray-50);overflow-x:auto;">
            <div class="mermaid">
flowchart LR
    A[User] --> B[Entra ID]
    B --> C{MFA<br/>Required?}
    C -->|Yes| D[MFA Challenge]
    D --> E{Result}
    E -->|Success| F[Access Granted]
    E -->|Denied 500121| G[MFA Fatigue Alert]
    C -->|No| F
    F --> H[Sign-in Log]
    G --> H
    H --> I[Splunk azure index]
    
    style B fill:#0078d4,stroke:#106ebe,color:#fff
    style G fill:#f8d7da,stroke:#dc3545
            </div>
          </div>
        </div>


        <!-- Role Explanation -->
        <div class="callout info">
          <svg class="callout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
          <div class="callout-content">
            <div class="callout-title">Role at myfirstpro</div>
            <div class="callout-body">
              Primary SSO for ~129,000 employees. For <strong>privileged users</strong>, Entra ID federates to CyberArk for MFA. Use Entra ID logs for: location data (UC3/UC4), standard employee MFA, and correlation with CyberArk.<br><br>
              <strong>Index:</strong> <code>azure</code> | <strong>Sourcetype:</strong> <code>azure:aad:signin</code>
            </div>
          </div>
        </div>

        <!-- ==================== RAW LOG JOURNEY ==================== -->
        <div class="section">
          <h2 class="subsection-title">üìú Raw Log Journey: Source ‚Üí Splunk ‚Üí Detection</h2>
          <p style="color:var(--gray-600);margin-bottom:24px;">See exactly how Entra ID logs transform at each stage. <strong>Note:</strong> Entra has deeply nested JSON!</p>

          <!-- STAGE 1: Raw from Entra -->
          <div class="card" style="padding:20px;margin-bottom:16px;border-left:4px solid #0078d4;">
            <h4 style="color:#0078d4;margin-bottom:12px;">üì§ Stage 1: Raw JSON from Azure Event Hub</h4>
            <p style="font-size:0.8125rem;color:var(--gray-600);margin-bottom:12px;">This is what Microsoft sends via Event Hub/Diagnostic Settings:</p>
            <div class="code-block">
              <div class="code-header"><span class="code-title">Raw Entra ID Sign-in Event (JSON) - DEEPLY NESTED!</span></div>
              <div class="code-body">
                <pre style="font-size:0.7rem;"><code>{
  "time": "2025-01-30T10:15:30.1234567Z",
  "resourceId": "/tenants/12345678-abcd-efgh-ijkl-123456789012/providers/Microsoft.aadiam",
  "operationName": "Sign-in activity",
  "operationVersion": "1.0",
  "category": "SignInLogs",
  "tenantId": "12345678-abcd-efgh-ijkl-123456789012",
  "resultType": "50074",
  "resultSignature": "None",
  "resultDescription": "Strong authentication is required.",
  "durationMs": 0,
  "callerIpAddress": "203.0.113.50",
  "correlationId": "abc123-def456-ghi789",
  "identity": "Jane Smith",
  "Level": 4,
  "location": "CA",
  "properties": {
    "id": "sign-in-id-12345",
    "createdDateTime": "2025-01-30T10:15:30Z",
    "userDisplayName": "Jane Smith",
    "userPrincipalName": "jane.smith@myfirstpro.com",
    "userId": "user-guid-12345",
    "appId": "app-guid-67890",
    "appDisplayName": "Microsoft Teams",
    "ipAddress": "203.0.113.50",
    "ipAddressFromResourceProvider": null,
    "clientAppUsed": "Mobile Apps and Desktop clients",
    "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
    "correlationId": "abc123-def456-ghi789",
    "conditionalAccessStatus": "success",
    "originalRequestId": "req-12345",
    "isInteractive": true,
    "tokenIssuerName": "",
    "tokenIssuerType": "AzureAD",
    "processingTimeInMilliseconds": 234,
    "riskDetail": "none",
    "riskLevelAggregated": "none",
    "riskLevelDuringSignIn": "none",
    "riskState": "none",
    "riskEventTypes": [],
    "riskEventTypes_v2": [],
    "resourceDisplayName": "Microsoft Teams",
    "resourceId": "resource-guid-12345",
    "resourceServicePrincipalId": "sp-guid-12345",
    "authenticationMethodsUsed": [],
    "authenticationRequirement": "multiFactorAuthentication",
    "status": {
      "errorCode": 0,
      "failureReason": null,
      "additionalDetails": null
    },
    "deviceDetail": {
      "deviceId": "device-guid-12345",
      "displayName": "JANE-LAPTOP",
      "operatingSystem": "Windows 10",
      "browser": "Edge 120.0",
      "isCompliant": true,
      "isManaged": true,
      "trustType": "AzureAd"
    },
    "location": {
      "city": "Toronto",
      "state": "Ontario",
      "countryOrRegion": "CA",
      "geoCoordinates": {
        "latitude": 43.6532,
        "longitude": -79.3832
      }
    },
    "mfaDetail": {
      "authMethod": "PhoneAppNotification",
      "authDetail": "Notification was sent to authenticator app"
    },
    "authenticationDetails": [
      {
        "authenticationStepDateTime": "2025-01-30T10:15:25Z",
        "authenticationMethod": "Password",
        "authenticationMethodDetail": "Password in the cloud",
        "succeeded": true,
        "authenticationStepResultDetail": "MFA completed in Azure AD",
        "authenticationStepRequirement": "Primary authentication"
      },
      {
        "authenticationStepDateTime": "2025-01-30T10:15:30Z",
        "authenticationMethod": "PhoneAppNotification",
        "succeeded": true,
        "authenticationStepResultDetail": "MFA completed",
        "authenticationStepRequirement": "Additional authentication"
      }
    ]
  }
}</code></pre>
              </div>
            </div>
            <div class="callout warning" style="margin-top:12px;padding:12px;">
              <div class="callout-content">
                <div class="callout-body" style="font-size:0.8125rem;">
                  <strong>‚ö†Ô∏è Challenge:</strong> All the useful data is buried in <code>properties.*</code> - up to 3-4 levels deep!
                </div>
              </div>
            </div>
          </div>

          <!-- STAGE 2: In Splunk _raw -->
          <div class="card" style="padding:20px;margin-bottom:16px;border-left:4px solid #65a637;">
            <h4 style="color:#65a637;margin-bottom:12px;">üì• Stage 2: Arrives in Splunk (_raw field)</h4>
            <p style="font-size:0.8125rem;color:var(--gray-600);margin-bottom:12px;">When the event hits Splunk via Event Hub input:</p>
            <div class="code-block">
              <div class="code-header"><span class="code-title">Splunk _raw (One Long JSON String)</span></div>
              <div class="code-body">
                <pre style="font-size:0.7rem;"><code>index=azure sourcetype=azure:aad:signin earliest=-5m | head 1 | table _raw

_raw:
{"time":"2025-01-30T10:15:30.1234567Z","resourceId":"/tenants/12345678.../providers/Microsoft.aadiam","operationName":"Sign-in activity","category":"SignInLogs","properties":{"userPrincipalName":"jane.smith@myfirstpro.com","ipAddress":"203.0.113.50","appDisplayName":"Microsoft Teams","status":{"errorCode":0},"location":{"city":"Toronto","countryOrRegion":"CA"},"mfaDetail":{"authMethod":"PhoneAppNotification"}...}}</code></pre>
              </div>
            </div>
            <div class="callout critical" style="margin-top:12px;padding:12px;">
              <div class="callout-content">
                <div class="callout-body" style="font-size:0.8125rem;">
                  <strong>‚ùå Problem:</strong> Without TA or manual extraction, you can't search for <code>userPrincipalName</code> directly! You'd need <code>spath</code> every time.
                </div>
              </div>
            </div>
          </div>

          <!-- STAGE 3: After spath Extraction -->
          <div class="card" style="padding:20px;margin-bottom:16px;border-left:4px solid var(--primary-500);">
            <h4 style="color:var(--primary-700);margin-bottom:12px;">‚öôÔ∏è Stage 3: After spath Extraction (Search-Time)</h4>
            <p style="font-size:0.8125rem;color:var(--gray-600);margin-bottom:12px;">Using <code>spath</code> to extract nested fields:</p>
            <div class="code-block">
              <div class="code-header"><span class="code-title">Extracted Fields with spath</span></div>
              <div class="code-body">
                <pre style="font-size:0.75rem;"><code>index=azure sourcetype=azure:aad:signin earliest=-5m 
| spath 
| head 1 
| table properties.userPrincipalName properties.ipAddress properties.status.errorCode properties.location.city

EXTRACTED FIELDS (with spath):
properties.userPrincipalName           = jane.smith@myfirstpro.com
properties.ipAddress                   = 203.0.113.50
properties.appDisplayName              = Microsoft Teams
properties.status.errorCode            = 0
properties.status.failureReason        = null
properties.location.city               = Toronto
properties.location.countryOrRegion    = CA
properties.mfaDetail.authMethod        = PhoneAppNotification
properties.deviceDetail.operatingSystem = Windows 10
properties.authenticationRequirement   = multiFactorAuthentication</code></pre>
              </div>
            </div>
            <div class="callout info" style="margin-top:12px;padding:12px;">
              <div class="callout-content">
                <div class="callout-body" style="font-size:0.8125rem;">
                  <strong>üí° Note:</strong> <code>spath</code> is slow on large datasets. For production, configure calculated fields in props.conf!
                </div>
              </div>
            </div>
          </div>

          <!-- STAGE 4: CIM Mapped / Friendly Names -->
          <div class="card" style="padding:20px;margin-bottom:16px;border-left:4px solid var(--success-500);">
            <h4 style="color:var(--success-700);margin-bottom:12px;">‚úÖ Stage 4: CIM-Mapped Fields (Detection Ready)</h4>
            <p style="font-size:0.8125rem;color:var(--gray-600);margin-bottom:12px;">With TA or calculated fields, use clean CIM field names:</p>
            <div class="code-block">
              <div class="code-header"><span class="code-title">CIM Fields (Ready for Detections)</span></div>
              <div class="code-body">
                <pre style="font-size:0.75rem;"><code>index=azure sourcetype=azure:aad:signin earliest=-5m | head 1 
| table _time user src_ip app action error_code city country authentication_method

CIM FIELDS:
_time                  = 2025-01-30 10:15:30
user                   = jane.smith@myfirstpro.com  ‚Üê properties.userPrincipalName
src_ip                 = 203.0.113.50               ‚Üê properties.ipAddress
app                    = Microsoft Teams            ‚Üê properties.appDisplayName
action                 = success                    ‚Üê mapped from errorCode=0
error_code             = 0                          ‚Üê properties.status.errorCode
city                   = Toronto                    ‚Üê properties.location.city
country                = CA                         ‚Üê properties.location.countryOrRegion
authentication_method  = PhoneAppNotification       ‚Üê properties.mfaDetail.authMethod</code></pre>
              </div>
            </div>
          </div>

          <!-- Visual Summary -->
          <div class="card" style="padding:24px;background:var(--gray-50);margin-bottom:24px;">
            <h4 style="margin-bottom:16px;">üîÑ Field Transformation Summary (Nested Paths!)</h4>
            <div class="table-container">
              <table style="font-size:0.75rem;">
                <thead><tr><th>Data</th><th>Entra JSON Path</th><th>‚Üí</th><th>CIM Field</th></tr></thead>
                <tbody>
                  <tr><td>User</td><td><code>properties.userPrincipalName</code></td><td>‚Üí</td><td><code>user</code></td></tr>
                  <tr><td>IP</td><td><code>properties.ipAddress</code></td><td>‚Üí</td><td><code>src_ip</code></td></tr>
                  <tr><td>App</td><td><code>properties.appDisplayName</code></td><td>‚Üí</td><td><code>app</code></td></tr>
                  <tr><td>Error</td><td><code>properties.status.errorCode</code></td><td>‚Üí</td><td><code>error_code</code> + <code>action</code></td></tr>
                  <tr><td>City</td><td><code>properties.location.city</code></td><td>‚Üí</td><td><code>city</code></td></tr>
                  <tr><td>Country</td><td><code>properties.location.countryOrRegion</code></td><td>‚Üí</td><td><code>country</code></td></tr>
                  <tr><td>MFA</td><td><code>properties.mfaDetail.authMethod</code></td><td>‚Üí</td><td><code>authentication_method</code></td></tr>
                  <tr><td>Device</td><td><code>properties.deviceDetail.operatingSystem</code></td><td>‚Üí</td><td><code>src_os</code></td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Error Codes Reference -->
          <div class="card" style="padding:20px;margin-bottom:16px;border-left:4px solid #dc3545;">
            <h4 style="color:#dc3545;margin-bottom:12px;">üö® Critical Error Codes (properties.status.errorCode)</h4>
            <div class="table-container">
              <table style="font-size:0.8125rem;">
                <thead><tr><th>Error Code</th><th>Meaning</th><th>Detection Use</th></tr></thead>
                <tbody>
                  <tr><td><code>0</code></td><td>Success</td><td>Normal login, track for anomalies</td></tr>
                  <tr><td><code>50074</code></td><td>Strong auth required</td><td>MFA challenge triggered</td></tr>
                  <tr><td><code>50076</code></td><td>MFA required but not completed</td><td>Partial auth - investigate</td></tr>
                  <tr><td><code>500121</code></td><td><strong>MFA DENIED</strong></td><td>üî¥ KEY for MFA fatigue detection!</td></tr>
                  <tr><td><code>50053</code></td><td>Account locked</td><td>Brute force indicator</td></tr>
                  <tr><td><code>50126</code></td><td>Invalid username/password</td><td>Failed password attempt</td></tr>
                  <tr><td><code>53003</code></td><td>Blocked by Conditional Access</td><td>Policy enforcement</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Sample Detection Using CIM -->
          <div class="card bordered-left success" style="padding:20px;">
            <h4 style="color:var(--success-700);margin-bottom:12px;">üéØ Now You Can Write Detections!</h4>
            <p style="font-size:0.8125rem;color:var(--gray-600);margin-bottom:12px;">With extracted/CIM fields, MFA and location detections are straightforward:</p>
            <div class="code-block">
              <div class="code-header"><span class="code-title">Detection: MFA Denial from New Location</span></div>
              <div class="code-body">
                <pre style="font-size:0.7rem;"><code>index=azure sourcetype=azure:aad:signin earliest=-24h
| spath
| eval user = 'properties.userPrincipalName'
| eval src_ip = 'properties.ipAddress'
| eval error_code = 'properties.status.errorCode'
| eval city = 'properties.location.city'
| eval country = 'properties.location.countryOrRegion'
| eval action = if(error_code=0, "success", "failure")

``` Filter for MFA denials
| where error_code=500121

``` Check for unusual location
| lookup user_locations.csv user OUTPUT usual_cities usual_countries
| eval is_new_location = if(NOT match(usual_cities, city), "true", "false")
| where is_new_location="true"

| stats count as mfa_denials 
        values(city) as attempted_cities 
        values(src_ip) as source_ips 
        BY user
| where mfa_denials >= 3
| eval severity = if(mfa_denials >= 5, "CRITICAL", "HIGH")
| eval alert = "MFA denied ".mfa_denials." times from new location: ".attempted_cities
| table user mfa_denials attempted_cities source_ips severity alert</code></pre>
              </div>
            </div>
          </div>
        </div>

        <!-- Log Types -->
        <div class="section">
          <h2 class="subsection-title">Entra ID Log Types</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr><th>Log Type</th><th>Sourcetype</th><th>Detection Use</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td class="highlight">Sign-in Logs</td>
                  <td><code>azure:aad:signin</code></td>
                  <td><span class="badge critical">PRIMARY</span> Auth, MFA, location</td>
                </tr>
                <tr>
                  <td>Audit Logs</td>
                  <td><code>azure:aad:audit</code></td>
                  <td>User/role changes, app registration</td>
                </tr>
                <tr>
                  <td>Identity Protection</td>
                  <td><code>azure:aad:identity</code></td>
                  <td>Risk detections from Microsoft</td>
                </tr>
                <tr>
                  <td>Provisioning</td>
                  <td><code>azure:aad:provisioning</code></td>
                  <td>Lifecycle events</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Critical Error Codes -->
        <div class="section">
          <h2 class="subsection-title">Critical Error Codes for Detection</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr><th>Code</th><th>Meaning</th><th>Detection Use</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td class="highlight"><code>0</code></td>
                  <td>Success</td>
                  <td>Successful authentication</td>
                </tr>
                <tr>
                  <td class="highlight"><code>500121</code></td>
                  <td>MFA Denied by User</td>
                  <td><span class="badge critical">PRIMARY</span> MFA fatigue detection</td>
                </tr>
                <tr>
                  <td class="highlight"><code>50074</code></td>
                  <td>Strong auth required</td>
                  <td>MFA challenge pending</td>
                </tr>
                <tr>
                  <td class="highlight"><code>50076</code></td>
                  <td>MFA required but failed</td>
                  <td>MFA failure tracking</td>
                </tr>
                <tr>
                  <td class="highlight"><code>50126</code></td>
                  <td>Invalid credentials</td>
                  <td>Password spraying, credential stuffing</td>
                </tr>
                <tr>
                  <td><code>53003</code></td>
                  <td>Blocked by Conditional Access</td>
                  <td>Policy enforcement</td>
                </tr>
                <tr>
                  <td><code>50053</code></td>
                  <td>Account locked</td>
                  <td>Brute force indicator</td>
                </tr>
                <tr>
                  <td><code>50057</code></td>
                  <td>Account disabled</td>
                  <td>Suspicious activity on disabled accounts</td>
                </tr>
                <tr>
                  <td><code>530032</code></td>
                  <td>Security default blocked</td>
                  <td>Legacy auth blocked</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Field Schema -->
        <div class="section">
          <h2 class="subsection-title">Sign-in Log Field Schema</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr><th>Field Path</th><th>Description</th><th>CIM Mapping</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td class="highlight"><code>properties.userPrincipalName</code></td>
                  <td>User email/UPN</td>
                  <td><code>user</code></td>
                </tr>
                <tr>
                  <td class="highlight"><code>properties.status.errorCode</code></td>
                  <td>Result code (0=success)</td>
                  <td><code>result_code</code></td>
                </tr>
                <tr>
                  <td class="highlight"><code>properties.ipAddress</code></td>
                  <td>Source IP</td>
                  <td><code>src</code></td>
                </tr>
                <tr>
                  <td class="highlight"><code>properties.location.city</code></td>
                  <td>Source city</td>
                  <td><code>src_city</code></td>
                </tr>
                <tr>
                  <td class="highlight"><code>properties.location.countryOrRegion</code></td>
                  <td>Source country</td>
                  <td><code>src_country</code></td>
                </tr>
                <tr>
                  <td><code>properties.location.geoCoordinates.latitude</code></td>
                  <td>Latitude</td>
                  <td>-</td>
                </tr>
                <tr>
                  <td><code>properties.location.geoCoordinates.longitude</code></td>
                  <td>Longitude</td>
                  <td>-</td>
                </tr>
                <tr>
                  <td><code>properties.mfaDetail.authMethod</code></td>
                  <td>MFA method used</td>
                  <td><code>authentication_method</code></td>
                </tr>
                <tr>
                  <td><code>properties.appDisplayName</code></td>
                  <td>Application accessed</td>
                  <td><code>app</code></td>
                </tr>
                <tr>
                  <td><code>properties.deviceDetail.browser</code></td>
                  <td>Browser used</td>
                  <td>-</td>
                </tr>
                <tr>
                  <td><code>properties.deviceDetail.operatingSystem</code></td>
                  <td>OS</td>
                  <td>-</td>
                </tr>
                <tr>
                  <td><code>properties.riskState</code></td>
                  <td>Risk state from Identity Protection</td>
                  <td>-</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- MFA Detection SPL -->
        <div class="section">
          <h2 class="subsection-title">MFA Fatigue Detection (Entra ID)</h2>
          <div class="code-block">
            <div class="code-header">
              <span class="code-title">MFA-UC1 (Entra ID variant for standard users)</span>
              <span class="code-lang">SPL</span>
            </div>
            <div class="code-body">
              <pre><code>index=azure sourcetype=azure:aad:signin earliest=-15m
| spath
| eval user = 'properties.userPrincipalName'
| eval error_code = 'properties.status.errorCode'
| eval src_ip = 'properties.ipAddress'
| eval city = 'properties.location.city'
| eval country = 'properties.location.countryOrRegion'
| eval app = 'properties.appDisplayName'

``` MFA denial = error code 500121
| eval mfa_denied = if(error_code=500121, 1, 0)
| eval mfa_success = if(error_code=0 AND isnotnull('properties.mfaDetail.authMethod'), 1, 0)

``` Aggregate by user in 10-minute windows
| bin _time span=10m
| stats sum(mfa_denied) as denials 
        sum(mfa_success) as successes
        values(src_ip) as source_ips
        values(city) as cities
        values(country) as countries
        values(app) as applications
        BY _time user

``` Alert on 5+ denials
| where denials >= 5

``` CRITICAL if followed by success (compromise indicator)
| eval severity = case(
    denials >= 5 AND successes >= 1, "CRITICAL",
    denials >= 10, "CRITICAL",
    1=1, "HIGH"
)

| eval alert = if(successes >= 1, 
    "MFA BYPASS DETECTED - Account likely compromised", 
    "MFA Fatigue Attack in progress")

| table _time user denials successes source_ips cities countries applications severity alert</code></pre>
            </div>
          </div>
        </div>

        <!-- Impossible Travel -->
        <div class="section">
          <h2 class="subsection-title">Impossible Travel Detection</h2>
          <div class="code-block">
            <div class="code-header">
              <span class="code-title">MFA-UC4: Detect physically impossible login locations</span>
            </div>
            <div class="code-body">
              <pre><code>index=azure sourcetype=azure:aad:signin earliest=-4h
| spath
| eval user = 'properties.userPrincipalName'
| eval error_code = 'properties.status.errorCode'
| where error_code = 0

``` Optional: focus on privileged users
| lookup privileged_users.csv userPrincipalName as user OUTPUT is_privileged
| where is_privileged = "true"

``` Extract geolocation
| eval lat = 'properties.location.geoCoordinates.latitude'
| eval lon = 'properties.location.geoCoordinates.longitude'
| eval city = 'properties.location.city'
| eval country = 'properties.location.countryOrRegion'
| where isnotnull(lat) AND isnotnull(lon)

``` Get previous login for each user
| sort 0 user _time
| streamstats current=f window=1 
    first(lat) as prev_lat 
    first(lon) as prev_lon 
    first(_time) as prev_time 
    first(city) as prev_city 
    first(country) as prev_country
    BY user

| where isnotnull(prev_lat)

``` Calculate distance using Haversine formula (simplified)
| eval distance_km = 6371 * acos(
    cos(lat*3.14159/180) * cos(prev_lat*3.14159/180) *
    cos((prev_lon-lon)*3.14159/180) +
    sin(lat*3.14159/180) * sin(prev_lat*3.14159/180))

``` Calculate travel speed
| eval time_diff_hours = (_time - prev_time) / 3600
| eval speed_kmh = round(distance_km / time_diff_hours, 0)

``` Flag impossible travel (>800 km/h = faster than commercial flight)
| where distance_km > 500 AND speed_kmh > 800

| eval alert = "Impossible travel: " . prev_city . " ‚Üí " . city . 
    " (" . round(distance_km,0) . " km in " . round(time_diff_hours,1) . " hours = " . speed_kmh . " km/h)"

| table _time user prev_city prev_country city country distance_km time_diff_hours speed_kmh alert</code></pre>
            </div>
          </div>
        </div>

        <!-- Validation Queries -->
        <div class="section">
          <h2 class="subsection-title">Validation Queries</h2>
          
          <div class="code-block">
            <div class="code-header">
              <span class="code-title">Check Entra ID Data Presence</span>
            </div>
            <div class="code-body">
              <pre><code>index=azure sourcetype=azure:aad:signin earliest=-1h
| spath
| stats count as events 
        dc(properties.userPrincipalName) as unique_users
        dc(properties.status.errorCode) as error_codes
        latest(_time) as last_event
| eval last_event = strftime(last_event, "%Y-%m-%d %H:%M:%S")
| eval status = if(events > 0, "‚úÖ Data flowing", "‚ùå No data")</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">Authentication Result Distribution</span>
            </div>
            <div class="code-body">
              <pre><code>index=azure sourcetype=azure:aad:signin earliest=-24h
| spath path=properties.status.errorCode output=error_code
| stats count BY error_code
| sort - count
| head 20</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">MFA Method Distribution</span>
            </div>
            <div class="code-body">
              <pre><code>index=azure sourcetype=azure:aad:signin earliest=-7d
| spath
| where isnotnull('properties.mfaDetail.authMethod')
| stats count BY properties.mfaDetail.authMethod
| sort - count</code></pre>
            </div>
          </div>
        </div>

        <!-- props.conf -->
        <div class="section">
          <h2 class="subsection-title">props.conf Configuration</h2>
          <div class="code-block">
            <div class="code-header">
              <span class="code-title">Entra ID CIM Field Aliases</span>
            </div>
            <div class="code-body">
              <pre><code>[azure:aad:signin]
# Timestamp
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%6N%Z
TIME_PREFIX = \"createdDateTime\":\"
MAX_TIMESTAMP_LOOKAHEAD = 50
TZ = UTC

# Parsing
KV_MODE = json
TRUNCATE = 0
SHOULD_LINEMERGE = false

# CIM Field Aliases
FIELDALIAS-user = properties.userPrincipalName AS user
FIELDALIAS-src = properties.ipAddress AS src
FIELDALIAS-src_city = properties.location.city AS src_city
FIELDALIAS-src_country = properties.location.countryOrRegion AS src_country
FIELDALIAS-app = properties.appDisplayName AS app

# Calculated Fields
EVAL-action = case(
    'properties.status.errorCode'==0, "success",
    1=1, "failure"
)
EVAL-result_code = 'properties.status.errorCode'
EVAL-vendor = "Microsoft"
EVAL-product = "Entra ID"</code></pre>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>
  <script src="../js/app.js"></script>
  <script>mermaid.initialize({startOnLoad:true, theme:'neutral'});</script>
</body>
</html>
