<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SPL Reference | myfirstpro Detection Engineering</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <div class="app-container">
                                    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <a href="../index.html" style="display:flex;align-items:center;gap:12px;text-decoration:none;color:inherit;">
            <div class="sidebar-logo-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            </div>
            <div class="sidebar-logo-text">
              <h1>myfirstpro</h1>
              <span>Detection Engineering</span>
            </div>
          </a>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Getting Started</div>
          <a href="../index.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg><span>Command Center</span></a>
          <a href="day1.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/></svg><span>Day 1 Checklist</span></a>
          <a href="client-comm.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg><span>Client Communication</span></a>
          <a href="professional-excellence.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg><span>Professional Excellence</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Splunk Fundamentals</div>
          <a href="splunk-fundamentals.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><span>Splunk 101</span></a>
          <a href="splunk-es.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg><span>Enterprise Security</span></a>
          <a href="data-flow.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span>Data Flow & Event Hub</span></a>
          <a href="detection-lifecycle.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/></svg><span>Detection Lifecycle</span></a>
          <a href="splunk-howto.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg><span>Splunk How-To Guide</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Data Sources</div>
          <a href="vendor-akamai.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg><span>Akamai WAF</span></a>
          <a href="vendor-cyberark.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg><span>CyberArk Identity</span></a>
          <a href="vendor-entra.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><span>Entra ID</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Splunk Operations</div>
          <a href="waf-onboarding.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span>Log Onboarding</span></a>
          <a href="parsing-cim.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg><span>Parsing & CIM</span></a>
          <a href="lookups.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg><span>Lookups Deep Dive</span></a>
          <a href="splunk-ops.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg><span>Splunk Cloud Ops</span></a>
          <a href="spl-reference.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg><span>SPL Reference</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">WAF/DDoS Project</div>
          <a href="waf-overview.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span>Project Overview</span></a>
          <a href="waf-usecases.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg><span>Use Cases (UC1-8)</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">MFA Project</div>
          <a href="mfa-overview.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span>Project Overview</span></a>
          <a href="mfa-usecases.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg><span>Use Cases (UC1-5)</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Response & Support</div>
          <a href="decision-trees.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="3"/><line x1="12" y1="8" x2="12" y2="14"/><circle cx="6" cy="19" r="3"/><circle cx="18" cy="19" r="3"/></svg><span>Decision Trees</span></a>
          <a href="troubleshooting.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><span>Troubleshooting</span></a>
          <a href="runbooks.html" class="nav-item"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg><span>SOC Runbooks</span></a>
        </div>
      </nav>
      <div class="sidebar-footer"><p>Detection Engineering v2.0</p></div>
    </aside>

    <main class="main-content">
      <header class="header">
        <div class="header-left">
          <button class="menu-toggle" aria-label="Toggle menu">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
          </button>
          <div class="breadcrumb">
            <a href="../index.html" class="breadcrumb-item">Home</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item current">SPL Reference</span>
          </div>
        </div>
        <span class="badge splunk">Copy-Paste Ready</span>
      </header>

      <div class="page-content">
        <div class="section">
          <h1 class="section-title">SPL Quick Reference</h1>
          <p class="section-subtitle">Copy-paste queries for Akamai WAF, CyberArk, and Entra ID</p>
        </div>

        <!-- Quick Navigation -->
        <div class="section">
          <div class="grid grid-4">
            <a href="#commands" class="card clickable">
              <h4 style="font-size:0.9rem;">üìö Commands Deep Dive</h4>
              <p style="font-size:0.75rem;color:var(--gray-500);">Complete use cases</p>
            </a>
            <a href="#validation" class="card clickable">
              <h4 style="font-size:0.9rem;">Data Validation</h4>
              <p style="font-size:0.75rem;color:var(--gray-500);">Check data presence</p>
            </a>
            <a href="#waf" class="card clickable">
              <h4 style="font-size:0.9rem;">WAF Detections</h4>
              <p style="font-size:0.75rem;color:var(--gray-500);">Akamai queries</p>
            </a>
            <a href="#mfa" class="card clickable">
              <h4 style="font-size:0.9rem;">MFA Detections</h4>
              <p style="font-size:0.75rem;color:var(--gray-500);">CyberArk + Entra</p>
            </a>
          </div>
        </div>

        <!-- ==================== SPL COMMANDS DEEP DIVE ==================== -->
        <div class="section" id="commands">
          <h2 class="subsection-title">üìö SPL Commands Deep Dive</h2>
          <p style="color:var(--gray-600);margin-bottom:24px;">Complete use cases, scenarios, and examples for every essential command</p>

          <!-- ===== STATS COMMAND ===== -->
          <div class="card" style="padding:24px;margin-bottom:24px;border-left:4px solid var(--primary-500);">
            <h3 style="font-size:1.125rem;margin-bottom:16px;color:var(--primary-700);">üìä stats ‚Äî Aggregate Data</h3>
            <p style="font-size:0.875rem;color:var(--gray-600);margin-bottom:16px;">
              <strong>When to Use:</strong> When you need to count, sum, average, or aggregate data. This is your go-to command for analysis.
            </p>
            
            <div class="table-container" style="margin-bottom:16px;">
              <table style="font-size:0.8125rem;">
                <thead><tr><th>Function</th><th>What It Does</th><th>Example</th></tr></thead>
                <tbody>
                  <tr><td><code>count</code></td><td>Count events</td><td><code>stats count</code></td></tr>
                  <tr><td><code>dc(field)</code></td><td>Distinct count (unique values)</td><td><code>stats dc(src_ip) as unique_ips</code></td></tr>
                  <tr><td><code>sum(field)</code></td><td>Add up values</td><td><code>stats sum(bytes) as total_bytes</code></td></tr>
                  <tr><td><code>avg(field)</code></td><td>Calculate average</td><td><code>stats avg(response_time)</code></td></tr>
                  <tr><td><code>values(field)</code></td><td>List all unique values</td><td><code>stats values(user) as users</code></td></tr>
                  <tr><td><code>latest(field)</code></td><td>Most recent value</td><td><code>stats latest(_time) as last_seen</code></td></tr>
                  <tr><td><code>earliest(field)</code></td><td>Oldest value</td><td><code>stats earliest(_time) as first_seen</code></td></tr>
                </tbody>
              </table>
            </div>

            <h4 style="font-size:0.9rem;margin:16px 0 8px;color:var(--gray-700);">üéØ Use Case Scenarios:</h4>
            
            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 1: Count attacks per IP</span></div>
              <div class="code-body"><pre><code>index=akamai action=blocked earliest=-1h
| stats count as attacks BY src_ip
| sort - attacks
| head 10</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 2: Multiple aggregations at once</span></div>
              <div class="code-body"><pre><code>index=akamai action=blocked earliest=-1h
| stats count as total_blocks 
        dc(src_ip) as unique_attackers 
        dc(uri_path) as targeted_endpoints
        values(http_method) as methods_used
        earliest(_time) as attack_start
        latest(_time) as attack_end
        BY dest</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 3: User login patterns</span></div>
              <div class="code-body"><pre><code>index=cyberark EventType=*Login* earliest=-24h
| stats count as login_attempts 
        dc(ClientIP) as unique_locations 
        values(City) as cities
        sum(eval(Result="Success")) as successes
        sum(eval(Result="Failure")) as failures
        BY Username
| eval success_rate = round(successes/login_attempts*100, 1)."%"</code></pre></div>
            </div>

            <div class="callout info" style="margin-top:12px;">
              <div class="callout-content">
                <div class="callout-body" style="font-size:0.8125rem;">
                  <strong>üí° Pro Tip:</strong> Use <code>BY field1, field2</code> to group by multiple fields. Without BY, stats aggregates everything into one row.
                </div>
              </div>
            </div>
          </div>

          <!-- ===== EVAL COMMAND ===== -->
          <div class="card" style="padding:24px;margin-bottom:24px;border-left:4px solid var(--success-500);">
            <h3 style="font-size:1.125rem;margin-bottom:16px;color:var(--success-700);">üîß eval ‚Äî Create & Modify Fields</h3>
            <p style="font-size:0.875rem;color:var(--gray-600);margin-bottom:16px;">
              <strong>When to Use:</strong> When you need to calculate new fields, transform values, or add conditional logic.
            </p>

            <div class="table-container" style="margin-bottom:16px;">
              <table style="font-size:0.8125rem;">
                <thead><tr><th>Function</th><th>What It Does</th><th>Example</th></tr></thead>
                <tbody>
                  <tr><td><code>if(condition, true, false)</code></td><td>Simple conditional</td><td><code>eval status=if(count>100, "high", "low")</code></td></tr>
                  <tr><td><code>case(cond1, val1, cond2, val2...)</code></td><td>Multiple conditions</td><td><code>eval severity=case(count>100,"critical", count>50,"high", 1=1,"medium")</code></td></tr>
                  <tr><td><code>coalesce(f1, f2, f3)</code></td><td>First non-null value</td><td><code>eval user=coalesce(username, email, "unknown")</code></td></tr>
                  <tr><td><code>lower(field)</code></td><td>Convert to lowercase</td><td><code>eval user=lower(Username)</code></td></tr>
                  <tr><td><code>round(num, decimals)</code></td><td>Round numbers</td><td><code>eval pct=round(ratio*100, 2)</code></td></tr>
                  <tr><td><code>strftime(time, format)</code></td><td>Format time</td><td><code>eval date=strftime(_time, "%Y-%m-%d")</code></td></tr>
                  <tr><td><code>now()</code></td><td>Current timestamp</td><td><code>eval age_hours=(now()-_time)/3600</code></td></tr>
                </tbody>
              </table>
            </div>

            <h4 style="font-size:0.9rem;margin:16px 0 8px;color:var(--gray-700);">üéØ Use Case Scenarios:</h4>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 1: Categorize severity levels</span></div>
              <div class="code-body"><pre><code>index=akamai action=blocked earliest=-1h
| stats count as attacks BY src_ip
| eval severity = case(
    attacks >= 1000, "CRITICAL",
    attacks >= 500, "HIGH", 
    attacks >= 100, "MEDIUM",
    1=1, "LOW"
)
| eval alert_message = "IP ".src_ip." blocked ".attacks." times - ".severity</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 2: Calculate time differences</span></div>
              <div class="code-body"><pre><code>index=cyberark EventType=*Login* earliest=-24h
| sort 0 Username _time
| streamstats current=f last(_time) as prev_login BY Username
| eval time_since_last = (_time - prev_login) / 60
| eval time_since_last_str = round(time_since_last, 0)." minutes"
| where isnotnull(prev_login)</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 3: Normalize fields from different sources</span></div>
              <div class="code-body"><pre><code>(index=cyberark) OR (index=azure)
| eval user = lower(coalesce(ActorId, 'properties.userPrincipalName'))
| eval src_ip = coalesce(ClientIP, 'properties.ipAddress')
| eval source_system = case(
    sourcetype=="cyberark:identity:audit", "CyberArk",
    sourcetype=="azure:aad:signin", "EntraID",
    1=1, "Unknown"
)</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 4: Calculate ratios and percentages</span></div>
              <div class="code-body"><pre><code>index=akamai earliest=-24h
| stats count as total 
        count(eval(action="blocked")) as blocked
        count(eval(action="allowed")) as allowed
| eval block_rate = round(blocked/total*100, 2)."%"
| eval risk_level = if(blocked/total > 0.1, "HIGH ATTACK ACTIVITY", "NORMAL")</code></pre></div>
            </div>
          </div>

          <!-- ===== WHERE COMMAND ===== -->
          <div class="card" style="padding:24px;margin-bottom:24px;border-left:4px solid var(--warning-500);">
            <h3 style="font-size:1.125rem;margin-bottom:16px;color:var(--warning-700);">üîç where ‚Äî Filter Results</h3>
            <p style="font-size:0.875rem;color:var(--gray-600);margin-bottom:16px;">
              <strong>When to Use:</strong> After stats/eval to filter calculated results. Use <code>search</code> for raw event filtering, <code>where</code> for computed values.
            </p>

            <div class="table-container" style="margin-bottom:16px;">
              <table style="font-size:0.8125rem;">
                <thead><tr><th>Operator</th><th>What It Does</th><th>Example</th></tr></thead>
                <tbody>
                  <tr><td><code>=, !=</code></td><td>Equals / Not equals</td><td><code>where action="blocked"</code></td></tr>
                  <tr><td><code>&gt;, &lt;, &gt;=, &lt;=</code></td><td>Comparisons</td><td><code>where count > 100</code></td></tr>
                  <tr><td><code>AND, OR, NOT</code></td><td>Logical operators</td><td><code>where count > 100 AND user!="admin"</code></td></tr>
                  <tr><td><code>like(field, pattern)</code></td><td>Wildcard match</td><td><code>where like(user, "%admin%")</code></td></tr>
                  <tr><td><code>match(field, regex)</code></td><td>Regex match</td><td><code>where match(uri, "(?i)login")</code></td></tr>
                  <tr><td><code>isnotnull(field)</code></td><td>Check field exists</td><td><code>where isnotnull(src_ip)</code></td></tr>
                  <tr><td><code>isnull(field)</code></td><td>Check field missing</td><td><code>where isnull(error_code)</code></td></tr>
                  <tr><td><code>cidrmatch(cidr, ip)</code></td><td>IP in CIDR range</td><td><code>where cidrmatch("10.0.0.0/8", src_ip)</code></td></tr>
                </tbody>
              </table>
            </div>

            <h4 style="font-size:0.9rem;margin:16px 0 8px;color:var(--gray-700);">üéØ Use Case Scenarios:</h4>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 1: Filter by threshold after aggregation</span></div>
              <div class="code-body"><pre><code>index=akamai action=blocked earliest=-1h
| stats count as attacks BY src_ip
| where attacks > 50
| sort - attacks</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 2: Multiple conditions</span></div>
              <div class="code-body"><pre><code>index=cyberark earliest=-24h
| stats count as attempts 
        sum(eval(Result="Failure")) as failures 
        BY Username
| where attempts > 10 AND failures > 5
| eval failure_rate = round(failures/attempts*100, 1)
| where failure_rate > 50</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 3: Exclude internal IPs</span></div>
              <div class="code-body"><pre><code>index=akamai action=blocked earliest=-1h
| stats count BY src_ip
| where NOT cidrmatch("10.0.0.0/8", src_ip) 
    AND NOT cidrmatch("172.16.0.0/12", src_ip) 
    AND NOT cidrmatch("192.168.0.0/16", src_ip)</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 4: Regex pattern matching</span></div>
              <div class="code-body"><pre><code>index=akamai earliest=-1h
| where match(uri_path, "(?i)(admin|config|setup|install)")
| stats count BY uri_path src_ip
| where count > 5</code></pre></div>
            </div>
          </div>

          <!-- ===== LOOKUP COMMAND ===== -->
          <div class="card" style="padding:24px;margin-bottom:24px;border-left:4px solid #9333ea;">
            <h3 style="font-size:1.125rem;margin-bottom:16px;color:#9333ea;">üìã lookup ‚Äî Enrich with External Data</h3>
            <p style="font-size:0.875rem;color:var(--gray-600);margin-bottom:16px;">
              <strong>When to Use:</strong> When you need to add context from CSV files (user info, asset data, threat intel, etc.)
            </p>

            <div class="table-container" style="margin-bottom:16px;">
              <table style="font-size:0.8125rem;">
                <thead><tr><th>Syntax</th><th>What It Does</th></tr></thead>
                <tbody>
                  <tr><td><code>lookup file.csv field</code></td><td>Basic lookup (auto-matches field name)</td></tr>
                  <tr><td><code>lookup file.csv csv_field AS event_field</code></td><td>Map different field names</td></tr>
                  <tr><td><code>lookup file.csv field OUTPUT col1, col2</code></td><td>Get specific columns only</td></tr>
                  <tr><td><code>lookup file.csv field OUTPUTNEW col1</code></td><td>Don't overwrite existing fields</td></tr>
                </tbody>
              </table>
            </div>

            <h4 style="font-size:0.9rem;margin:16px 0 8px;color:var(--gray-700);">üéØ Use Case Scenarios:</h4>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 1: Identify privileged users</span></div>
              <div class="code-body"><pre><code>index=cyberark EventType=*MfaDenied* earliest=-1h
| lookup privileged_users.csv userPrincipalName AS Username OUTPUT is_privileged role department
| where is_privileged="true"
| stats count BY Username role department</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 2: Add asset information</span></div>
              <div class="code-body"><pre><code>index=akamai action=blocked earliest=-1h
| lookup assets.csv hostname AS dest OUTPUT asset_criticality owner business_unit
| where asset_criticality="critical"
| stats count BY dest owner business_unit</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 3: Threat intel enrichment</span></div>
              <div class="code-body"><pre><code>index=akamai action=blocked earliest=-24h
| lookup threat_intel.csv ip AS src_ip OUTPUT threat_type threat_score country_risk
| where isnotnull(threat_type)
| stats count values(threat_type) as threats max(threat_score) as max_score BY src_ip</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 4: GeoIP lookup</span></div>
              <div class="code-body"><pre><code>index=akamai earliest=-1h
| iplocation src_ip
| lookup country_risk.csv country AS Country OUTPUT risk_level blocked_country
| where blocked_country="true" OR risk_level="high"</code></pre></div>
            </div>

            <div class="callout warning" style="margin-top:12px;">
              <div class="callout-content">
                <div class="callout-body" style="font-size:0.8125rem;">
                  <strong>‚ö†Ô∏è Requirement:</strong> Lookup files must be uploaded to Splunk first via <strong>Settings ‚Üí Lookups ‚Üí Lookup table files</strong>
                </div>
              </div>
            </div>
          </div>

          <!-- ===== TIMECHART COMMAND ===== -->
          <div class="card" style="padding:24px;margin-bottom:24px;border-left:4px solid #0891b2;">
            <h3 style="font-size:1.125rem;margin-bottom:16px;color:#0891b2;">üìà timechart ‚Äî Time-Series Visualization</h3>
            <p style="font-size:0.875rem;color:var(--gray-600);margin-bottom:16px;">
              <strong>When to Use:</strong> When you need to visualize trends over time. Creates data perfect for line/area charts.
            </p>

            <div class="table-container" style="margin-bottom:16px;">
              <table style="font-size:0.8125rem;">
                <thead><tr><th>Syntax</th><th>What It Does</th></tr></thead>
                <tbody>
                  <tr><td><code>timechart count</code></td><td>Count events over time (auto-span)</td></tr>
                  <tr><td><code>timechart span=1h count</code></td><td>Count per hour</td></tr>
                  <tr><td><code>timechart count BY field</code></td><td>Split by field values</td></tr>
                  <tr><td><code>timechart count BY field limit=5</code></td><td>Limit to top 5 values</td></tr>
                  <tr><td><code>timechart avg(field)</code></td><td>Average value over time</td></tr>
                </tbody>
              </table>
            </div>

            <h4 style="font-size:0.9rem;margin:16px 0 8px;color:var(--gray-700);">üéØ Use Case Scenarios:</h4>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 1: Attack volume over time</span></div>
              <div class="code-body"><pre><code>index=akamai action=blocked earliest=-24h
| timechart span=1h count as blocks</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 2: Compare attack types over time</span></div>
              <div class="code-body"><pre><code>index=akamai action=blocked earliest=-7d
| timechart span=1d count BY signature limit=5</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 3: Login trends by result</span></div>
              <div class="code-body"><pre><code>index=cyberark EventType=*Login* earliest=-7d
| timechart span=1d count BY Result</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 4: MFA denial trend for specific user</span></div>
              <div class="code-body"><pre><code>index=cyberark EventType=*MfaDenied* Username="admin@company.com" earliest=-30d
| timechart span=1d count as mfa_denials
| trendline sma7(mfa_denials) as trend</code></pre></div>
            </div>
          </div>

          <!-- ===== REX COMMAND ===== -->
          <div class="card" style="padding:24px;margin-bottom:24px;border-left:4px solid #dc2626;">
            <h3 style="font-size:1.125rem;margin-bottom:16px;color:#dc2626;">üî§ rex ‚Äî Extract with Regex</h3>
            <p style="font-size:0.875rem;color:var(--gray-600);margin-bottom:16px;">
              <strong>When to Use:</strong> When you need to extract values from unstructured text using regular expressions.
            </p>

            <div class="table-container" style="margin-bottom:16px;">
              <table style="font-size:0.8125rem;">
                <thead><tr><th>Syntax</th><th>What It Does</th></tr></thead>
                <tbody>
                  <tr><td><code>rex "(?&lt;fieldname&gt;pattern)"</code></td><td>Extract from _raw into new field</td></tr>
                  <tr><td><code>rex field=myfield "(?&lt;new&gt;pattern)"</code></td><td>Extract from specific field</td></tr>
                  <tr><td><code>rex mode=sed "s/old/new/g"</code></td><td>Search and replace</td></tr>
                </tbody>
              </table>
            </div>

            <h4 style="font-size:0.9rem;margin:16px 0 8px;color:var(--gray-700);">üéØ Use Case Scenarios:</h4>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 1: Extract API endpoints</span></div>
              <div class="code-body"><pre><code>index=akamai earliest=-1h
| rex field=uri_path "(?<api_endpoint>/api/[^/]+)"
| stats count BY api_endpoint
| sort - count</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 2: Extract domain from email</span></div>
              <div class="code-body"><pre><code>index=cyberark earliest=-24h
| rex field=Username "(?<email_domain>@[\w.-]+)"
| stats dc(Username) as users BY email_domain</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 3: Extract parameters from URL</span></div>
              <div class="code-body"><pre><code>index=akamai earliest=-1h
| rex field=uri_path "\?(?<query_params>.*)"
| rex field=query_params "id=(?<extracted_id>[^&]+)"
| where isnotnull(extracted_id)
| stats count BY extracted_id</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 4: Clean/mask sensitive data</span></div>
              <div class="code-body"><pre><code>index=akamai earliest=-1h
| rex mode=sed field=uri_path "s/password=[^&]+/password=***MASKED***/g"
| rex mode=sed field=uri_path "s/token=[^&]+/token=***MASKED***/g"
| table _time uri_path</code></pre></div>
            </div>
          </div>

          <!-- ===== DEDUP COMMAND ===== -->
          <div class="card" style="padding:24px;margin-bottom:24px;border-left:4px solid #65a30d;">
            <h3 style="font-size:1.125rem;margin-bottom:16px;color:#65a30d;">üîÑ dedup ‚Äî Remove Duplicates</h3>
            <p style="font-size:0.875rem;color:var(--gray-600);margin-bottom:16px;">
              <strong>When to Use:</strong> When you need unique values only, keeping the first (most recent) occurrence.
            </p>

            <h4 style="font-size:0.9rem;margin:16px 0 8px;color:var(--gray-700);">üéØ Use Case Scenarios:</h4>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 1: Unique attackers only</span></div>
              <div class="code-body"><pre><code>index=akamai action=blocked earliest=-1h
| dedup src_ip
| table _time src_ip geo.country uri_path</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 2: Latest event per user</span></div>
              <div class="code-body"><pre><code>index=cyberark earliest=-24h
| sort 0 - _time
| dedup Username
| table _time Username EventType Result ClientIP</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 3: Unique IP + path combinations</span></div>
              <div class="code-body"><pre><code>index=akamai action=blocked earliest=-1h
| dedup src_ip uri_path
| stats count BY uri_path
| sort - count</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 4: Keep top N duplicates</span></div>
              <div class="code-body"><pre><code>index=akamai action=blocked earliest=-1h
| dedup 3 src_ip
| table _time src_ip uri_path
``` Keeps first 3 events per src_ip</code></pre></div>
            </div>
          </div>

          <!-- ===== BIN/BUCKET COMMAND ===== -->
          <div class="card" style="padding:24px;margin-bottom:24px;border-left:4px solid #ea580c;">
            <h3 style="font-size:1.125rem;margin-bottom:16px;color:#ea580c;">‚è±Ô∏è bin ‚Äî Time Bucketing</h3>
            <p style="font-size:0.875rem;color:var(--gray-600);margin-bottom:16px;">
              <strong>When to Use:</strong> When you need to group events into time windows before aggregating with stats.
            </p>

            <div class="table-container" style="margin-bottom:16px;">
              <table style="font-size:0.8125rem;">
                <thead><tr><th>Span</th><th>Meaning</th><th>Use For</th></tr></thead>
                <tbody>
                  <tr><td><code>span=1m</code></td><td>1 minute</td><td>Real-time alerting</td></tr>
                  <tr><td><code>span=5m</code></td><td>5 minutes</td><td>Near real-time detection</td></tr>
                  <tr><td><code>span=1h</code></td><td>1 hour</td><td>Hourly trends</td></tr>
                  <tr><td><code>span=1d</code></td><td>1 day</td><td>Daily patterns</td></tr>
                  <tr><td><code>span=1w</code></td><td>1 week</td><td>Weekly trends</td></tr>
                </tbody>
              </table>
            </div>

            <h4 style="font-size:0.9rem;margin:16px 0 8px;color:var(--gray-700);">üéØ Use Case Scenarios:</h4>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 1: 5-minute attack windows</span></div>
              <div class="code-body"><pre><code>index=akamai action=blocked earliest=-1h
| bin _time span=5m
| stats count as attacks dc(src_ip) as unique_ips BY _time
| where attacks > 100</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 2: Hourly login patterns</span></div>
              <div class="code-body"><pre><code>index=cyberark EventType=*Login* earliest=-7d
| bin _time span=1h
| stats count as logins BY _time
| eval hour = strftime(_time, "%H")
| stats avg(logins) as avg_logins BY hour
| sort hour</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 3: MFA fatigue detection (10-min windows)</span></div>
              <div class="code-body"><pre><code>index=cyberark EventType=*Mfa* earliest=-30m
| bin _time span=10m
| stats sum(eval(Result="Denied")) as denials 
        sum(eval(Result="Success")) as successes 
        BY _time Username
| where denials >= 5
| eval severity = if(successes > 0, "CRITICAL", "HIGH")</code></pre></div>
            </div>
          </div>

          <!-- ===== TABLE COMMAND ===== -->
          <div class="card" style="padding:24px;margin-bottom:24px;border-left:4px solid #6366f1;">
            <h3 style="font-size:1.125rem;margin-bottom:16px;color:#6366f1;">üìã table ‚Äî Display Results</h3>
            <p style="font-size:0.875rem;color:var(--gray-600);margin-bottom:16px;">
              <strong>When to Use:</strong> Always at the end of your query to select which fields to display and in what order.
            </p>

            <h4 style="font-size:0.9rem;margin:16px 0 8px;color:var(--gray-700);">üéØ Use Case Scenarios:</h4>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 1: Simple field selection</span></div>
              <div class="code-body"><pre><code>index=akamai action=blocked earliest=-1h
| table _time src_ip dest uri_path http_method action</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 2: Rename fields in output</span></div>
              <div class="code-body"><pre><code>index=akamai action=blocked earliest=-1h
| stats count as attacks BY src_ip
| rename src_ip as "Source IP", attacks as "Attack Count"
| table "Source IP" "Attack Count"</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Scenario 3: Alert-ready output</span></div>
              <div class="code-body"><pre><code>index=akamai action=blocked earliest=-1h
| stats count as attacks dc(uri_path) as endpoints BY src_ip
| where attacks > 100
| eval severity = if(attacks > 500, "CRITICAL", "HIGH")
| eval alert_title = "High Attack Volume from ".src_ip
| table alert_title severity attacks endpoints src_ip</code></pre></div>
            </div>
          </div>

          <!-- ===== TIME RANGE REFERENCE ===== -->
          <div class="card" style="padding:24px;margin-bottom:24px;border-left:4px solid #0d9488;">
            <h3 style="font-size:1.125rem;margin-bottom:16px;color:#0d9488;">üïê Time Range Modifiers</h3>
            
            <div class="table-container" style="margin-bottom:16px;">
              <table style="font-size:0.8125rem;">
                <thead><tr><th>Modifier</th><th>Meaning</th><th>Example</th></tr></thead>
                <tbody>
                  <tr><td><code>earliest=-1h</code></td><td>From 1 hour ago</td><td><code>index=akamai earliest=-1h</code></td></tr>
                  <tr><td><code>earliest=-24h</code></td><td>From 24 hours ago</td><td><code>index=akamai earliest=-24h</code></td></tr>
                  <tr><td><code>earliest=-7d</code></td><td>From 7 days ago</td><td><code>index=akamai earliest=-7d</code></td></tr>
                  <tr><td><code>earliest=@d</code></td><td>From start of today</td><td><code>index=akamai earliest=@d</code></td></tr>
                  <tr><td><code>earliest=-1d@d</code></td><td>From start of yesterday</td><td><code>index=akamai earliest=-1d@d latest=@d</code></td></tr>
                  <tr><td><code>earliest=-1w@w</code></td><td>From start of last week</td><td><code>index=akamai earliest=-1w@w</code></td></tr>
                  <tr><td><code>earliest=-1mon@mon</code></td><td>From start of last month</td><td><code>index=akamai earliest=-1mon@mon latest=@mon</code></td></tr>
                </tbody>
              </table>
            </div>

            <h4 style="font-size:0.9rem;margin:16px 0 8px;color:var(--gray-700);">üéØ Common Time Range Patterns:</h4>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Pattern 1: Last full hour</span></div>
              <div class="code-body"><pre><code>index=akamai earliest=-1h@h latest=@h</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Pattern 2: Yesterday only</span></div>
              <div class="code-body"><pre><code>index=akamai earliest=-1d@d latest=@d</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Pattern 3: Last 7 full days (for baseline)</span></div>
              <div class="code-body"><pre><code>index=akamai earliest=-8d@d latest=-1d@d</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">Pattern 4: Business hours only</span></div>
              <div class="code-body"><pre><code>index=cyberark earliest=-7d
| eval hour = strftime(_time, "%H")
| where hour >= 9 AND hour <= 17</code></pre></div>
            </div>
          </div>

          <!-- ===== ADDITIONAL USEFUL COMMANDS ===== -->
          <div class="card" style="padding:24px;margin-bottom:24px;border-left:4px solid #78716c;">
            <h3 style="font-size:1.125rem;margin-bottom:16px;color:#78716c;">üõ†Ô∏è Additional Useful Commands</h3>
            
            <div class="table-container" style="margin-bottom:16px;">
              <table style="font-size:0.8125rem;">
                <thead><tr><th>Command</th><th>What It Does</th><th>Example</th></tr></thead>
                <tbody>
                  <tr><td><code>sort</code></td><td>Sort results (- for descending)</td><td><code>sort - count</code></td></tr>
                  <tr><td><code>head</code></td><td>First N results</td><td><code>head 10</code></td></tr>
                  <tr><td><code>tail</code></td><td>Last N results</td><td><code>tail 10</code></td></tr>
                  <tr><td><code>rename</code></td><td>Rename fields</td><td><code>rename src_ip as "Source IP"</code></td></tr>
                  <tr><td><code>fillnull</code></td><td>Replace null values</td><td><code>fillnull value="N/A"</code></td></tr>
                  <tr><td><code>spath</code></td><td>Extract JSON fields</td><td><code>spath path=properties.user</code></td></tr>
                  <tr><td><code>mvexpand</code></td><td>Expand multi-value field</td><td><code>mvexpand rules</code></td></tr>
                  <tr><td><code>transaction</code></td><td>Group related events</td><td><code>transaction user maxspan=30m</code></td></tr>
                  <tr><td><code>eventstats</code></td><td>Stats without reducing rows</td><td><code>eventstats avg(count) as baseline</code></td></tr>
                  <tr><td><code>streamstats</code></td><td>Running calculations</td><td><code>streamstats sum(count) as running_total</code></td></tr>
                </tbody>
              </table>
            </div>

            <h4 style="font-size:0.9rem;margin:16px 0 8px;color:var(--gray-700);">üéØ Quick Examples:</h4>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">eventstats: Add baseline to each row</span></div>
              <div class="code-body"><pre><code>index=akamai action=blocked earliest=-1h
| bin _time span=5m
| stats count BY _time
| eventstats avg(count) as baseline stdev(count) as stdev
| eval threshold = baseline + (2 * stdev)
| where count > threshold</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">transaction: Group login attempts into sessions</span></div>
              <div class="code-body"><pre><code>index=cyberark EventType=*Login* earliest=-24h
| transaction Username maxspan=30m maxpause=5m
| eval duration_min = duration / 60
| eval event_count = eventcount
| where event_count > 5
| table _time Username event_count duration_min</code></pre></div>
            </div>

            <div class="code-block" style="margin-bottom:12px;">
              <div class="code-header"><span class="code-title">streamstats: Running count per user</span></div>
              <div class="code-body"><pre><code>index=cyberark EventType=*MfaDenied* earliest=-1h
| sort 0 Username _time
| streamstats count as denial_sequence BY Username
| where denial_sequence >= 5
| table _time Username denial_sequence</code></pre></div>
            </div>
          </div>
        </div>

        <!-- DATA VALIDATION SECTION -->
        <div class="section" id="validation">
          <h2 class="subsection-title">Data Validation Queries</h2>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">Check All Data Sources at Once</span>
            </div>
            <div class="code-body">
              <pre><code>| tstats count WHERE index IN (akamai, cyberark, azure) BY index sourcetype
| eval status = if(count > 0, "‚úÖ OK", "‚ùå Missing")
| sort index</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">Akamai WAF Data Check</span>
            </div>
            <div class="code-body">
              <pre><code>index=akamai sourcetype=akamai:siem earliest=-1h
| stats count as events 
        dc(attackData.clientIP) as unique_ips
        dc(httpMessage.requestHeaders.Host) as unique_hosts
        latest(_time) as last_event
| eval last_event = strftime(last_event, "%Y-%m-%d %H:%M:%S")
| eval age_minutes = round((now() - last_event) / 60, 1)
| eval status = case(events=0, "‚ùå No data", age_minutes > 15, "‚ö†Ô∏è Stale", 1=1, "‚úÖ OK")</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">CyberArk Data Check</span>
            </div>
            <div class="code-body">
              <pre><code>index=cyberark sourcetype=cyberark:identity:audit earliest=-1h
| stats count as events 
        dc(ActorId) as unique_users
        dc(EventType) as event_types
        latest(_time) as last_event
| eval last_event = strftime(last_event, "%Y-%m-%d %H:%M:%S")
| eval status = if(events > 0, "‚úÖ Data flowing", "‚ùå No data")</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">Entra ID Data Check</span>
            </div>
            <div class="code-body">
              <pre><code>index=azure sourcetype=azure:aad:signin earliest=-1h
| spath
| stats count as events 
        dc(properties.userPrincipalName) as unique_users
        latest(_time) as last_event
| eval last_event = strftime(last_event, "%Y-%m-%d %H:%M:%S")
| eval status = if(events > 0, "‚úÖ Data flowing", "‚ùå No data")</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">Field Extraction Validation</span>
            </div>
            <div class="code-body">
              <pre><code>index=akamai sourcetype=akamai:siem earliest=-1h
| fieldsummary 
| eval coverage = round(count/totalCount*100, 1)."%"
| table field count distinct_count coverage
| sort - count</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">Indexing Latency Check</span>
            </div>
            <div class="code-body">
              <pre><code>index=akamai sourcetype=akamai:siem earliest=-1h
| eval latency_seconds = _indextime - _time
| stats avg(latency_seconds) as avg_latency 
        max(latency_seconds) as max_latency 
        p95(latency_seconds) as p95_latency
| eval avg_min = round(avg_latency/60, 1)." min"
| eval max_min = round(max_latency/60, 1)." min"
| eval p95_min = round(p95_latency/60, 1)." min"
| eval status = if(p95_latency/60 < 10, "‚úÖ OK", "‚ö†Ô∏è High latency")</code></pre>
            </div>
          </div>
        </div>

        <!-- WAF DETECTIONS SECTION -->
        <div class="section" id="waf">
          <h2 class="subsection-title">WAF/DDoS Detection Queries (Akamai)</h2>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">WAF-UC1: Block Volume Anomaly</span>
              <span class="code-lang">Production Ready</span>
            </div>
            <div class="code-body">
              <pre><code>index=akamai sourcetype=akamai:siem earliest=-10m
| spath path=attackData.rules{}.ruleAction output=action
| where action="deny"
| bin _time span=5m
| stats count as block_count 
        dc(attackData.clientIP) as unique_ips 
        values(httpMessage.requestHeaders.Host) as hosts
        BY _time
| eventstats avg(block_count) as baseline stdev(block_count) as stdev
| eval threshold = baseline + (2 * stdev)
| eval threshold = if(threshold < 50, 50, threshold)
| where block_count > threshold AND block_count > 10
| eval deviation = round((block_count - baseline) / stdev, 2)
| eval severity = case(deviation >= 5, "CRITICAL", deviation >= 3, "HIGH", 1=1, "MEDIUM")
| table _time block_count baseline threshold deviation unique_ips hosts severity</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">WAF-UC2: Single Source Flood</span>
            </div>
            <div class="code-body">
              <pre><code>index=akamai sourcetype=akamai:siem earliest=-5m
| bin _time span=1m
| stats count as total_requests 
        count(eval('attackData.rules{}.ruleAction'="deny")) as blocked
        values(httpMessage.path) as paths
        BY _time attackData.clientIP geo.country
| where total_requests > 500 OR blocked > 50
| eval block_ratio = round(blocked/total_requests*100, 1)."%"
| sort - total_requests</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">WAF-UC3: Auth Endpoint Attack</span>
            </div>
            <div class="code-body">
              <pre><code>index=akamai sourcetype=akamai:siem earliest=-10m
| spath path=attackData.rules{}.ruleAction output=action
| where action="deny"
| where match(httpMessage.path, "(?i)(login|auth|signin|oauth|token|session)")
| bin _time span=5m
| stats count as blocked 
        dc(attackData.clientIP) as unique_attackers
        values(attackData.clientIP) as attacker_ips
        BY _time httpMessage.path
| where blocked > 20 OR (blocked > 5 AND unique_attackers > 3)
| eval severity = if(blocked > 50, "CRITICAL", "HIGH")
| table _time httpMessage.path blocked unique_attackers attacker_ips severity</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">WAF-UC4: SQLi/XSS Campaign</span>
            </div>
            <div class="code-body">
              <pre><code>index=akamai sourcetype=akamai:siem earliest=-10m
| spath path=attackData.rules{}.ruleAction output=action
| spath path=attackData.rules{}.ruleTag output=category
| where action="deny" AND category IN ("SQLI", "XSS", "CMD", "LFI", "RFI")
| bin _time span=5m
| stats count as attack_count
        dc(attackData.clientIP) as unique_attackers
        values(attackData.clientIP) as attacker_ips
        values(category) as attack_types
        BY _time
| where attack_count > 15
| eval severity = case(
    attack_count > 100, "CRITICAL",
    attack_count > 50, "HIGH",
    1=1, "MEDIUM"
)
| table _time attack_count unique_attackers attack_types attacker_ips severity</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">Top Blocked IPs (Last 24h)</span>
            </div>
            <div class="code-body">
              <pre><code>index=akamai sourcetype=akamai:siem earliest=-24h
| spath path=attackData.rules{}.ruleAction output=action
| where action="deny"
| stats count as blocks 
        dc(httpMessage.path) as unique_paths
        values(attackData.rules{}.ruleTag) as attack_types
        latest(geo.country) as country
        BY attackData.clientIP
| sort - blocks
| head 25</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">Geographic Block Distribution</span>
            </div>
            <div class="code-body">
              <pre><code>index=akamai sourcetype=akamai:siem earliest=-24h
| spath path=attackData.rules{}.ruleAction output=action
| where action="deny"
| stats count as blocks dc(attackData.clientIP) as unique_ips BY geo.country
| eventstats sum(blocks) as total
| eval percentage = round(blocks/total*100, 1)."%"
| sort - blocks
| head 20</code></pre>
            </div>
          </div>
        </div>

        <!-- MFA DETECTIONS SECTION -->
        <div class="section" id="mfa">
          <h2 class="subsection-title">MFA Detection Queries</h2>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">MFA-UC1: CyberArk MFA Fatigue Detection</span>
              <span class="code-lang">Production Ready</span>
            </div>
            <div class="code-body">
              <pre><code>index=cyberark sourcetype=cyberark:identity:audit earliest=-15m
    EventType IN ("Cloud.Core.MfaAuthentication", "Cloud.Core.MfaDenied", "Cloud.Core.MfaTimeout")
| spath
| eval user = ActorId
| eval mfa_denied = if(Result IN ("Failure", "Denied", "Timeout"), 1, 0)
| eval mfa_success = if(Result == "Success", 1, 0)
| lookup privileged_users.csv userPrincipalName as user OUTPUT is_privileged role
| where is_privileged = "true"
| bin _time span=10m
| stats sum(mfa_denied) as denials 
        sum(mfa_success) as successes
        values(ClientIP) as source_ips
        values(City) as cities
        latest(role) as role
        BY _time user
| where denials >= 5
| eval severity = if(denials >= 5 AND successes >= 1, "CRITICAL", "HIGH")
| eval alert = if(successes >= 1, "MFA BYPASS - Account compromised", "Push bombing in progress")
| table _time user role denials successes source_ips cities severity alert</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">MFA-UC1: Entra ID MFA Fatigue (Standard Users)</span>
            </div>
            <div class="code-body">
              <pre><code>index=azure sourcetype=azure:aad:signin earliest=-15m
| spath
| eval user = 'properties.userPrincipalName'
| eval error_code = 'properties.status.errorCode'
| eval mfa_denied = if(error_code=500121, 1, 0)
| eval mfa_success = if(error_code=0 AND isnotnull('properties.mfaDetail.authMethod'), 1, 0)
| bin _time span=10m
| stats sum(mfa_denied) as denials 
        sum(mfa_success) as successes
        values(properties.ipAddress) as source_ips
        values(properties.location.city) as cities
        BY _time user
| where denials >= 5
| eval severity = if(successes >= 1, "CRITICAL", "HIGH")
| table _time user denials successes source_ips cities severity</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">MFA-UC4: Impossible Travel Detection</span>
            </div>
            <div class="code-body">
              <pre><code>index=azure sourcetype=azure:aad:signin earliest=-4h
| spath
| eval user = 'properties.userPrincipalName'
| eval error_code = 'properties.status.errorCode'
| where error_code = 0
| lookup privileged_users.csv userPrincipalName as user OUTPUT is_privileged
| where is_privileged = "true"
| eval lat = 'properties.location.geoCoordinates.latitude'
| eval lon = 'properties.location.geoCoordinates.longitude'
| eval city = 'properties.location.city'
| where isnotnull(lat) AND isnotnull(lon)
| sort 0 user _time
| streamstats current=f window=1 
    first(lat) as prev_lat 
    first(lon) as prev_lon 
    first(_time) as prev_time 
    first(city) as prev_city 
    BY user
| where isnotnull(prev_lat)
| eval distance_km = 6371 * acos(
    cos(lat*3.14159/180)*cos(prev_lat*3.14159/180)*
    cos((prev_lon-lon)*3.14159/180)+
    sin(lat*3.14159/180)*sin(prev_lat*3.14159/180))
| eval time_diff_hours = (_time - prev_time) / 3600
| eval speed_kmh = round(distance_km / time_diff_hours, 0)
| where distance_km > 500 AND speed_kmh > 800
| eval alert = "Impossible travel: ".round(distance_km,0)." km in ".round(time_diff_hours,1)." hours (".speed_kmh." km/h)"
| table _time user prev_city city distance_km time_diff_hours speed_kmh alert</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">MFA Denial Trends by User</span>
            </div>
            <div class="code-body">
              <pre><code>index=cyberark sourcetype=cyberark:identity:audit earliest=-7d
    EventType IN ("Cloud.Core.MfaDenied", "Cloud.Core.MfaTimeout")
| timechart span=1d count BY ActorId limit=10</code></pre>
            </div>
          </div>
        </div>

        <!-- BASELINE CALCULATION SECTION -->
        <div class="section" id="baseline">
          <h2 class="subsection-title">Baseline Calculation Queries</h2>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">WAF Block Baseline (14 days)</span>
            </div>
            <div class="code-body">
              <pre><code>index=akamai sourcetype=akamai:siem earliest=-14d latest=-1d
| spath path=attackData.rules{}.ruleAction output=action
| where action="deny"
| bin _time span=5m
| stats count as blocks BY _time
| stats 
    avg(blocks) as mean
    stdev(blocks) as stdev
    perc50(blocks) as p50
    perc90(blocks) as p90
    perc95(blocks) as p95
    perc99(blocks) as p99
    min(blocks) as min_blocks
    max(blocks) as max_blocks
| eval threshold_2sigma = round(mean + (2*stdev), 0)
| eval threshold_3sigma = round(mean + (3*stdev), 0)
| eval recommendation = "Use threshold_2sigma (".threshold_2sigma.") for medium sensitivity"</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">Hour-of-Day Baseline</span>
            </div>
            <div class="code-body">
              <pre><code>index=akamai sourcetype=akamai:siem earliest=-14d latest=-1d
| spath path=attackData.rules{}.ruleAction output=action
| where action="deny"
| eval hour = strftime(_time, "%H")
| bin _time span=1h
| stats count as blocks BY _time hour
| stats avg(blocks) as avg_blocks stdev(blocks) as stdev BY hour
| eval threshold = round(avg_blocks + (2*stdev), 0)
| sort hour
| table hour avg_blocks stdev threshold</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">Day-of-Week Baseline</span>
            </div>
            <div class="code-body">
              <pre><code>index=akamai sourcetype=akamai:siem earliest=-28d latest=-1d
| spath path=attackData.rules{}.ruleAction output=action
| where action="deny"
| eval dow = strftime(_time, "%A")
| bin _time span=1d
| stats count as blocks BY _time dow
| stats avg(blocks) as avg_daily stdev(blocks) as stdev BY dow
| eval threshold = round(avg_daily + (2*stdev), 0)
| table dow avg_daily stdev threshold</code></pre>
            </div>
          </div>
        </div>

        <!-- UTILITY QUERIES SECTION -->
        <div class="section">
          <h2 class="subsection-title">Utility Queries</h2>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">Find All Available Indexes</span>
            </div>
            <div class="code-body">
              <pre><code>| eventcount summarize=false index=* 
| dedup index 
| fields index</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">Find Sourcetypes by Pattern</span>
            </div>
            <div class="code-body">
              <pre><code>| tstats count WHERE index=* sourcetype=*akamai* OR sourcetype=*cyberark* OR sourcetype=*azure* BY index sourcetype
| sort - count</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">Sample Raw Event</span>
            </div>
            <div class="code-body">
              <pre><code>index=akamai sourcetype=akamai:siem earliest=-1h
| head 1
| table _time _raw</code></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-header">
              <span class="code-title">Check Scheduled Search Status</span>
            </div>
            <div class="code-body">
              <pre><code>| rest /services/saved/searches
| search is_scheduled=1 disabled=0
| table title cron_schedule next_scheduled_time dispatch.earliest_time</code></pre>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>
  <script src="../js/app.js"></script>
</body>
</html>
